<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIoT æ‰‹å‹¢ç„¡äººæ©Ÿæ§åˆ¶ç³»çµ± - é–‹ç™¼èˆ‡é™¤éŒ¯å…¨ç´€éŒ„</title>
    <style>
        :root {
            --bg-color: #1e1e2e;
            --text-color: #cdd6f4;
            --primary-color: #89b4fa;
            --secondary-color: #f38ba8;
            --accent-color: #a6e3a1;
            --code-bg: #181825;
            --border-color: #313244;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px 10%;
        }
        h1, h2, h3 { color: var(--primary-color); }
        h1 { border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        h2 { margin-top: 40px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .highlight { color: var(--secondary-color); font-weight: bold; }
        .success { color: var(--accent-color); font-weight: bold; }
        code {
            background-color: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            color: #fab387;
        }
        pre {
            background-color: var(--code-bg);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid var(--border-color);
        }
        pre code { background-color: transparent; padding: 0; color: #cdd6f4; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: var(--code-bg);
        }
        th, td {
            padding: 12px;
            border: 1px solid var(--border-color);
            text-align: left;
        }
        th { background-color: #313244; color: var(--primary-color); }
        ul { padding-left: 20px; }
        li { margin-bottom: 8px; }
    </style>
</head>
<body>

    <h1>AIoT æ‰‹å‹¢ç„¡äººæ©Ÿæ§åˆ¶ç³»çµ± - æ ¸å¿ƒé–‹ç™¼æ–‡ä»¶</h1>
    <p><strong>ç³»çµ±æ¶æ§‹ï¼š</strong> Raspberry Pi 5 (Companion Computer) + Pixhawk 6C (PX4 v1.16) + MediaPipe AI è¦–è¦ºè¾¨è­˜</p>

    <h2>ä¸€ã€ ç¡¬é«”æ¥ç·šæŒ‡å— (Hardware Wiring)</h2>
    <p>ç¢ºä¿ RPi 5 èˆ‡ Pixhawk 6C ä¹‹é–“çš„é€šè¨Šéˆè·¯ç©©å®šï¼Œæ¡ç”¨ UART åºåˆ—åŸ é€£æ¥ã€‚</p>
    <table>
        <tr>
            <th>Raspberry Pi 5 (GPIO è…³ä½)</th>
            <th>Pixhawk 6C (TELEM 1 æˆ– TELEM 2)</th>
            <th>èªªæ˜</th>
        </tr>
        <tr>
            <td>Pin 6 (GND)</td>
            <td>GND</td>
            <td>å…±åœ°æ˜¯é€šè¨Šç©©å®šçš„çµ•å°å‰æ</td>
        </tr>
        <tr>
            <td>Pin 8 (GPIO 14 / TXD)</td>
            <td>RX</td>
            <td>è³‡æ–™ç™¼é€è‡³é£›æ§</td>
        </tr>
        <tr>
            <td>Pin 10 (GPIO 15 / RXD)</td>
            <td>TX</td>
            <td>æ¥æ”¶é£›æ§è³‡æ–™</td>
        </tr>
        <tr>
            <td>å¤–éƒ¨ 5V / 3A é›»æº</td>
            <td>ä¸å»ºè­°å¾ Pixhawk å–é›»</td>
            <td>RPi 5 é‹ä½œ AI è€—é›»é‡å¤§ï¼Œè«‹ä½¿ç”¨ç¨ç«‹ Type-C ä¾›é›»ã€‚Pixhawk ç”±ä¸»å‹•åŠ›é›»æ±  (LiPo) é€éé›»æºæ¨¡çµ„ä¾›é›»ã€‚</td>
        </tr>
    </table>
    <p><span class="highlight">âš ï¸ æ³¨æ„ï¼š</span> å½±åƒä¸²æµæ¡ç”¨ Raspberry Pi Camera Module 3ï¼Œæ’ç·šéœ€æ­£ç¢ºæ’å…¥ RPi 5 çš„ MIPI CSI æ¥å£ã€‚</p>

    <h2>äºŒã€ ç’°å¢ƒå»ºç½®èˆ‡ä¾è³´å®‰è£ (Environment Setup)</h2>
    <p>åœ¨ Raspberry Pi OS (Bookworm, 64-bit) ç’°å¢ƒä¸‹çš„å®‰è£æŒ‡ä»¤ï¼š</p>
    
    <h3>1. å•Ÿç”¨ UART åºåˆ—åŸ </h3>
    <p>ç·¨è¼¯ <code>/boot/firmware/config.txt</code> (æˆ–ä½¿ç”¨ <code>sudo raspi-config</code>)ï¼š</p>
    <ul>
        <li>é—œé–‰ Serial Consoleï¼š<code>enable_uart=1</code> ä¸”ç§»é™¤ <code>console=serial0,115200</code>ã€‚</li>
        <li>ç¢ºä¿ MAVSDK ä½¿ç”¨çš„å°æ‡‰åŸ å£ç‚º <code>/dev/ttyAMA0</code>ã€‚</li>
    </ul>

    <h3>2. å®‰è£ Python ä¾è³´åº«</h3>
    <pre><code># å»ºç«‹è™›æ“¬ç’°å¢ƒ (æ¨è–¦)
python3 -m venv ~/drone_env
source ~/drone_env/bin/activate

# å®‰è£æ ¸å¿ƒå¥—ä»¶
pip install mavsdk opencv-python mediapipe numpy
</code></pre>
    <p>â€» è¨»ï¼šæœ¬å°ˆæ¡ˆä½¿ç”¨ <code>rpicam-vid</code> æ“·å–ç¡¬é«”åŠ é€Ÿå½±åƒï¼Œæ­¤å·¥å…·ç‚º Raspberry Pi OS å…§å»ºã€‚</p>


    <h2>ä¸‰ã€ å¸¸è¦‹é€£ç·šèˆ‡è§£é–å¤±æ•—åŸå› åŠ SOP (Debugging SOP)</h2>
    <p>é‡å° PX4 v1.16 æ–°ç‰ˆéŸŒé«”ï¼Œåœ¨å®¤å…§ç„¡ GPS ç’°å¢ƒä¸‹é€²è¡Œ DEMO çš„å¸¸è¦‹å ±éŒ¯èˆ‡è§£æ³•ï¼š</p>

    <table>
        <tr>
            <th>éŒ¯èª¤ç¾è±¡ (QGC æç¤º)</th>
            <th>æ ¹æœ¬åŸå› </th>
            <th>è§£æ±ºæ–¹æ¡ˆ (SOP)</th>
        </tr>
        <tr>
            <td><strong>é¦¬é”æ¯«ç„¡åæ‡‰</strong><br>(å·²è§£é–ç¶ ç‡ˆä½†ä¸å‹•)</td>
            <td>PX4 v1.16 æœªé…ç½®å‹•æ…‹æ§åˆ¶åˆ†é… (Control Allocation)ã€‚PWM è…³ä½æœªæ˜ å°„ã€‚</td>
            <td>é€²å…¥ QGC -> Vehicle Setup -> Actuatorsã€‚<br>å°‡å¯¦é«” <code>I/O PWM Out 1~4</code> æ‰‹å‹•åˆ†é…ç‚º <code>Motor 1~4</code>ï¼Œä¸¦é‡å•Ÿé£›æ§ã€‚</td>
        </tr>
        <tr>
            <td><strong>Offboard åˆ‡æ›å¤±æ•—</strong><br>(Position is missing)</td>
            <td>å®¤å…§ç„¡ GPSï¼Œç„¡æ³•å»ºç«‹ä½ç½®èˆ‡é€Ÿåº¦ä¼°ç®— (EKF2 ç•°å¸¸)ã€‚</td>
            <td>æ”¾æ£„ <code>Velocity</code> æ§åˆ¶ï¼Œæ”¹ç”¨ <code>Attitude</code> (å§¿å‹¢èˆ‡æ¨åŠ›) æ§åˆ¶ã€‚<br>å°‡ QGC åƒæ•¸ <code>COM_ARM_WO_GPS</code> è¨­ç‚º <strong>1</strong>ã€‚</td>
        </tr>
        <tr>
            <td><strong>è§£é–è¢«æ‹’</strong><br>(Health failures first)</td>
            <td>é£›æ§å®‰å…¨é æª¢æœªé (ç¾…ç›¤å¹²æ“¾ã€æ²’æ¥é™æ§å™¨ã€ç¡¬é«”æŒ‰éˆ•æœªæŒ‰)ã€‚</td>
            <td>è¨­å®šæš´åŠ› DEMO åƒæ•¸ï¼š<br><code>CBRK_IO_SAFETY</code> = 22027<br><code>COM_RC_IN_MODE</code> = 1<br><code>SYS_HAS_MAG</code> = 0</td>
        </tr>
        <tr>
            <td><strong>è§£é–å¾Œç¬é–“åœè½‰</strong><br>(Takeoff/Landing detected)</td>
            <td>ç„¡äººæ©Ÿæœªå¯¦éš›å‡ç©ºï¼Œé™è½åµæ¸¬å™¨èª¤åˆ¤ç‚ºã€Œå·²è½åœ°ã€ä¸¦å¼·åˆ‡å‹•åŠ›ã€‚</td>
            <td>å°‡ QGC åƒæ•¸ <code>COM_DISARM_LAND</code> è¨­ç‚º <strong>-1</strong> (é—œé–‰è½åœ°ä¸Šé–)ï¼Œæˆ–åœ¨ç¨‹å¼ä¸­çµ¦äºˆè¶…é 50% çš„å¤§æ¨åŠ›ã€‚</td>
        </tr>
    </table>


    <h2>å››ã€ æ ¸å¿ƒæ‰‹å‹¢æ§åˆ¶ç¨‹å¼ç¢¼ (Attitude æ¨åŠ›ç‰ˆ)</h2>
    <p>æ­¤ç‰ˆæœ¬å·²å®Œå…¨ç§»é™¤å° GPS èˆ‡é€Ÿåº¦ä¼°ç®—çš„ä¾è³´ï¼Œç›´æ¥æ§åˆ¶é¦¬é”æ¨åŠ›ï¼Œé©åˆå®¤å…§ DEMOã€‚</p>
    <pre><code>import os
import time
import asyncio
import threading
import subprocess
import cv2
import numpy as np
import mediapipe as mp
from mavsdk import System
from mavsdk.offboard import Attitude, OffboardError

os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'

# --- å…¨åŸŸæ§åˆ¶è®Šæ•¸: [Roll, Pitch, Yaw, Thrust] ---
# Thrust ç¯„åœ 0.0 ~ 1.0 (0.15 ç‚ºæ€ é€Ÿ)
target_attitude = [0.0, 0.0, 0.0, 0.15] 
is_offboard_active = False

class CameraStream:
    def __init__(self, width=640, height=480, fps=40):
        self.width, self.height = width, height
        self.frame_size = int(width * height * 1.5)
        # å‘¼å«åº•å±¤ rpicam-vid å–å¾—ä½å»¶é² yuv å½±åƒ
        self.cmd = ["rpicam-vid", "-t", "0", "--width", str(width), "--height", str(height),
                    "--framerate", str(fps), "--codec", "yuv420", "--nopreview", "-o", "-"]
        self.process = subprocess.Popen(self.cmd, stdout=subprocess.PIPE, stderr=subprocess.DEVNULL)
        self.latest_frame_rgb = None
        self.running = True
        self.thread = threading.Thread(target=self._update, daemon=True)
        self.thread.start()

    def _update(self):
        while self.running:
            raw_data = self.process.stdout.read(self.frame_size)
            if len(raw_data) == self.frame_size:
                yuv = np.frombuffer(raw_data, dtype=np.uint8).reshape((int(self.height * 1.5), self.width))
                self.latest_frame_rgb = cv2.cvtColor(yuv, cv2.COLOR_YUV2RGB_I420)

    def read(self): return self.latest_frame_rgb
    
    def release(self):
        self.running = False
        self.process.terminate()

async def drone_control_loop(drone):
    """èƒŒæ™¯ç¶­æŒ 20Hz çš„ Offboard è¨Šè™Ÿç™¼é€ï¼Œé˜²æ­¢é£›æ§ Failsafe"""
    global target_attitude
    while True:
        try:
            await drone.offboard.set_attitude(
                Attitude(target_attitude[0], target_attitude[1], target_attitude[2], target_attitude[3])
            )
        except: pass
        await asyncio.sleep(0.05)

def get_fingers_count(hand_lms, label):
    """è¨ˆç®—ä¼¸å‡ºçš„æ‰‹æŒ‡æ•¸é‡"""
    fingers = []
    if label == "Right": fingers.append(hand_lms.landmark[4].x &lt; hand_lms.landmark[3].x)
    else: fingers.append(hand_lms.landmark[4].x &gt; hand_lms.landmark[3].x)
    for tip_id in [8, 12, 16, 20]: fingers.append(hand_lms.landmark[tip_id].y &lt; hand_lms.landmark[tip_id-2].y)
    return sum(fingers)

async def run():
    global target_attitude, is_offboard_active
    drone = System()
    print("æ­£åœ¨é€£ç·šè‡³ Pixhawk 6C (/dev/ttyAMA0:921600)...")
    await drone.connect(system_address="serial:///dev/ttyAMA0:921600")
    
    async for state in drone.core.connection_state():
        if state.is_connected:
            print("âœ… ç„¡äººæ©Ÿå·²é€£ç·šï¼")
            break

    # å•Ÿå‹•èƒŒæ™¯æ§åˆ¶è¿´åœˆ
    asyncio.create_task(drone_control_loop(drone))

    mp_hands = mp.solutions.hands
    hands = mp_hands.Hands(max_num_hands=1, model_complexity=0, min_detection_confidence=0.6)
    cap = CameraStream(640, 480, 40)
    pTime, avg_fps, status_text = 0, 0, "STANDBY"

    print("\nğŸš€ DEMO æµç¨‹ï¼šå…ˆç”¨ RC è§£é–ï¼Œé¦¬é”æ€ é€Ÿå¾Œï¼ŒæŒ‰ 'a' éµ AI æ¥ç®¡ã€‚")
    
    try:
        while True:
            frame_rgb = cap.read()
            if frame_rgb is None:
                await asyncio.sleep(0.001)
                continue

            frame_rgb = cv2.flip(frame_rgb, 1)
            results = hands.process(frame_rgb)
            frame_bgr = cv2.cvtColor(frame_rgb, cv2.COLOR_RGB2BGR)
            
            # é è¨­ç¶­æŒæ€ é€Ÿæ¨åŠ›
            new_att = [0.0, 0.0, 0.0, 0.15] 
            
            if results and results.multi_hand_landmarks:
                for i, hand_lms in enumerate(results.multi_hand_landmarks):
                    mp.solutions.drawing_utils.draw_landmarks(frame_bgr, hand_lms, mp_hands.HAND_CONNECTIONS)
                    label = results.multi_handedness[i].classification[0].label
                    count = get_fingers_count(hand_lms, label)

                    # æ‰‹å‹¢å°æ‡‰æ¨åŠ›é‚è¼¯
                    if count == 5: 
                        new_att[3] = 0.5  # æ¨åŠ› 50% (é¦¬é”é«˜è½‰)
                        status_text = "CLIMBING (Thrust 50%)"
                    elif count == 0: 
                        new_att[3] = 0.05 # æ¨åŠ› 5% (é¦¬é”ä½è½‰)
                        status_text = "DESCENDING (Thrust 5%)"
                    elif count == 1:
                        new_att[0] = 15.0 # Roll 15åº¦ (å³å‚¾)
                        new_att[3] = 0.2  
                        status_text = "MOVE RIGHT (Roll 15deg)"
                    else: 
                        new_att[3] = 0.15
                        status_text = "HOVERING (Idle)"
            else: 
                status_text = "SEARCHING..."
            
            target_attitude = new_att
            
            # FPS è¨ˆç®—
            cTime = time.time()
            if (cTime - pTime) &gt; 0:
                avg_fps = (avg_fps * 0.9) + ((1 / (cTime - pTime)) * 0.1)
                pTime = cTime
            
            # UI ç¹ªè£½
            cv2.putText(frame_bgr, f"MODE: {'OFFBOARD (AI)' if is_offboard_active else 'RC MANUAL'}", (10, 30), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 0, 255) if is_offboard_active else (0, 255, 255), 2)
            cv2.putText(frame_bgr, f"ACTION: {status_text}", (10, 60), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
            cv2.imshow('Marlon Drone AI', frame_bgr)
            
            key = cv2.waitKey(1) & 0xFF
            if key == ord('a'):
                print(">>> å˜—è©¦æ¥ç®¡æ§åˆ¶æ¬Š (Attitude æ¨¡å¼)...")
                try:
                    await drone.offboard.start()
                    is_offboard_active = True
                    print("âœ… æ¥ç®¡æˆåŠŸï¼")
                except OffboardError as e:
                    print(f"âŒ æ¥ç®¡å¤±æ•—: {e._result.result}")
            elif key == ord('q'): break
            await asyncio.sleep(0.001)

    finally:
        cap.release()
        cv2.destroyAllWindows()

if __name__ == "__main__":
    asyncio.run(run())
</code></pre>

</body>
</html>
