<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIoT æ‰‹å‹¢ç„¡äººæ©Ÿæ§åˆ¶ç³»çµ± - é–‹ç™¼èˆ‡é™¤éŒ¯å…¨ç´€éŒ„</title>
    <style>
        :root {
            --bg-color: #1e1e2e;
            --text-color: #cdd6f4;
            --primary-color: #89b4fa;
            --secondary-color: #f38ba8;
            --accent-color: #a6e3a1;
            --code-bg: #181825;
            --border-color: #313244;
            --sidebar-width: 260px;
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px 40px;
            /* é ç•™å·¦å´å›ºå®šå°è¦½åˆ—çš„ç©ºé–“ */
            padding-left: calc(var(--sidebar-width) + 60px); 
        }
        
        /* --- å·¦å´å›ºå®šç« ç¯€å°è¦½ (Sidebar) --- */
        .sidebar {
            position: fixed;
            top: 40px;
            left: 20px;
            width: var(--sidebar-width);
            background-color: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 4px 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        .sidebar h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.1em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar li {
            margin-bottom: 12px;
        }
        .sidebar a {
            color: var(--text-color);
            text-decoration: none;
            font-size: 0.95em;
            transition: color 0.2s;
            display: block;
        }
        .sidebar a:hover {
            color: var(--accent-color);
            padding-left: 5px;
            transition: all 0.2s;
        }

        /* --- å…§å®¹æ’ç‰ˆ --- */
        h1, h2, h3 { color: var(--primary-color); }
        h1 { border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        h2 { margin-top: 50px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; scroll-margin-top: 20px; }
        .highlight { color: var(--secondary-color); font-weight: bold; }
        .success { color: var(--accent-color); font-weight: bold; }
        code {
            background-color: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            color: #fab387;
        }
        pre {
            background-color: var(--code-bg);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid var(--border-color);
        }
        pre code { background-color: transparent; padding: 0; color: #cdd6f4; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: var(--code-bg);
        }
        th, td {
            padding: 12px;
            border: 1px solid var(--border-color);
            text-align: left;
        }
        th { background-color: #313244; color: var(--primary-color); }
        ul { padding-left: 20px; }
        li { margin-bottom: 8px; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <h3>ç« ç¯€å°è¦½</h3>
        <ul>
            <li><a href="#wiring">ä¸€ã€ RPi 5 èˆ‡é£›æ§æ¥ç·š (UART)</a></li>
            <li><a href="#env">äºŒã€ ç’°å¢ƒå»ºç½®èˆ‡ä¾è³´å®‰è£</a></li>
            <li><a href="#debug">ä¸‰ã€ é€£ç·šè§£é–é™¤éŒ¯ SOP</a></li>
            <li><a href="#code">å››ã€ æ‰‹å‹¢æ§åˆ¶ä»£ç¢¼ (æ¨åŠ›ç‰ˆ)</a></li>
        </ul>
    </nav>

    <h1>AIoT æ‰‹å‹¢ç„¡äººæ©Ÿæ§åˆ¶ç³»çµ± - æ ¸å¿ƒé–‹ç™¼æ–‡ä»¶</h1>
    <p><strong>ç³»çµ±æ¶æ§‹ï¼š</strong> Raspberry Pi 5 (Companion Computer) + Pixhawk 6C (PX4 v1.16) + MediaPipe AI è¦–è¦ºè¾¨è­˜</p>

    <h2 id="wiring">ä¸€ã€ RPi 5 èˆ‡é£›æ§æ¥ç·šèˆ‡ UART è¨­å®š (RPi 5 å°ˆå±¬)</h2>
    <p>Raspberry Pi 5 æ¡ç”¨å…¨æ–°çš„ RP1 æ™¶ç‰‡è™•ç† I/Oï¼ŒUART æ¶æ§‹èˆ‡èˆŠç‰ˆå®Œå…¨ä¸åŒã€‚ç‚ºäº†å¯¦ç¾å½±åƒæ§åˆ¶çš„ä½å»¶é²ï¼Œæˆ‘å€‘å¿…é ˆä½¿ç”¨ <strong>921600 æ³¢ç‰¹ç‡ (Baud Rate)</strong>ã€‚</p>
    
    <h3>1. å¯¦é«”æ¥ç·šå°æ‡‰ (å…©ç¨®æ–¹æ¡ˆ)</h3>
    <p>åœ¨ RPi 5 ä¸Šï¼Œä½ ä½¿ç”¨çš„æ¥å­”æ±ºå®šäº† Linux ç³»çµ±ä¸­çš„è¨­å‚™ä»£è™Ÿï¼š</p>
    <table>
        <tr>
            <th>æ–¹æ¡ˆ</th>
            <th>RPi 5 ç«¯æ¥å­”</th>
            <th>Pixhawk 6C (TELEM)</th>
            <th>å°æ‡‰çš„ Linux è¨­å‚™åç¨±</th>
        </tr>
        <tr>
            <td><strong>æ–¹æ¡ˆ A</strong> (æ¨è–¦)</td>
            <td><strong>å°ˆç”¨ 3-Pin Debug æ¥å£</strong> (UART)</td>
            <td>RX / TX / GND</td>
            <td><code>/dev/ttyAMA0</code></td>
        </tr>
        <tr>
            <td><strong>æ–¹æ¡ˆ B</strong></td>
            <td><strong>40-Pin GPIO æ’é‡</strong> (Pin 8: TX, Pin 10: RX, Pin 6: GND)</td>
            <td>RX / TX / GND</td>
            <td><code>/dev/ttyAMA10</code> (æˆ– ttyS0)</td>
        </tr>
    </table>
    <p><span class="highlight">âš ï¸ é›»æºè­¦å‘Šï¼š</span> åš´ç¦ç›´æ¥å¾ Pixhawk TELEM åŸ å–é›»çµ¦ RPi 5ï¼RPi 5 é‹ç®— AI è€—é›»æ¥µå¤§ï¼Œå¿…é ˆä½¿ç”¨ç¨ç«‹ Type-C ä¾›é›»ï¼ŒPixhawk å‰‡ç”±å‹•åŠ›é›»æ± ä¾›é›»ã€‚å…©è€…<strong>å¿…é ˆå…±åœ° (GND)</strong> é€šè¨Šæ‰æœƒç©©å®šã€‚</p>

    <h3>2. RPi 5 ç³»çµ±è¨­å®š (å•Ÿç”¨ 921600 é«˜é€Ÿ UART)</h3>
    <p>ç·¨è¼¯ boot åƒæ•¸æª”ï¼š</p>
    <pre><code>sudo nano /boot/firmware/config.txt</code></pre>
    <p><strong>è‹¥ä½¿ç”¨ 40-Pin GPIO (æ–¹æ¡ˆ B)ï¼š</strong></p>
    <p>åŠ å…¥ä»¥ä¸‹æŒ‡ä»¤ä»¥å•Ÿç”¨ RP1 æ™¶ç‰‡ä¸Šçš„ UART0ï¼Œä¸¦é—œé–‰é è¨­çš„ Serial Console é¿å…çµ‚ç«¯æ©Ÿå¹²æ“¾ï¼š</p>
    <pre><code>enable_uart=1
dtoverlay=uart0-pi5</code></pre>
    <p><em>(ä¿®æ”¹å¾Œéœ€ Rebootï¼Œç³»çµ±ä¸­å°‡å‡ºç¾ <code>/dev/ttyAMA10</code> ä¾› Python å‘¼å«)</em></p>

    <h3>3. Pixhawk (QGC) ç«¯ 921600 è¨­å®š</h3>
    <p>ç‚ºåŒ¹é… RPi 5 çš„é«˜é€Ÿå‚³è¼¸ï¼Œé£›æ§ç«¯å¿…é ˆç²¾æº–è¨­å®šï¼š</p>
    <ul>
        <li>æ‰“é–‹ QGC é€²å…¥åƒæ•¸è¨­å®š (Parameters)ã€‚</li>
        <li>ç¢ºèªæ¥ç·šçš„ TELEM åŸ  (å¦‚ TELEM 1)ã€‚</li>
        <li>æœå°‹ <code>SER_TEL1_BAUD</code>ï¼Œå°‡å…¶ä¿®æ”¹ç‚º <strong>921600 8N1</strong>ã€‚</li>
        <li>é‡å•Ÿ Pixhawkã€‚</li>
    </ul>

    <h2 id="env">äºŒã€ ç’°å¢ƒå»ºç½®èˆ‡ä¾è³´å®‰è£ (Environment Setup)</h2>
    <p>åœ¨ Raspberry Pi OS (Bookworm, 64-bit) å»ºè­°ä½¿ç”¨è™›æ“¬ç’°å¢ƒï¼š</p>
    <pre><code># 1. æ›´æ–°ç³»çµ±ä¸¦å®‰è£åŸºç¤è¦–è¦ºå¥—ä»¶ä¾è³´
sudo apt update
sudo apt install -y python3-venv libgl1-mesa-glx libglib2.0-0

# 2. å»ºç«‹ä¸¦é€²å…¥ Python è™›æ“¬ç’°å¢ƒ
python3 -m venv ~/drone_env
source ~/drone_env/bin/activate

# 3. å®‰è£ AIoT æ ¸å¿ƒå¥—ä»¶ (æ³¨æ„ MAVSDK ç‰ˆæœ¬ç›¸å®¹æ€§)
pip install mavsdk opencv-python mediapipe numpy
</code></pre>

    <h2 id="debug">ä¸‰ã€ é€£ç·šè§£é–é™¤éŒ¯ SOP (PX4 FW 1.16 å°ˆç”¨)</h2>
    <p>PX4 v1.16 çš„å¥åº·æª¢æŸ¥æ¥µåš´æ ¼ï¼Œè‹¥é‡åˆ°å•é¡Œè«‹ä¾åºæ’æŸ¥ï¼š</p>
    <table>
        <tr>
            <th>éŒ¯èª¤ç¾è±¡</th>
            <th>æ ¹æœ¬åŸå› </th>
            <th>è§£æ±ºæ–¹æ¡ˆ (QGC åƒæ•¸èˆ‡è¨­å®š)</th>
        </tr>
        <tr>
            <td><strong>é¦¬é”ç„¡åæ‡‰</strong><br>(å·²è§£é–ç¶ ç‡ˆä½†ä¸å‹•)</td>
            <td>FW 1.16 å‹•æ…‹æ§åˆ¶åˆ†é… (Control Allocation) æœªé…ç½®ã€‚PWM è…³ä½æœªæ˜ å°„ã€‚</td>
            <td>é€²å…¥ Actuators (åŸ·è¡Œå™¨)ã€‚æ‰‹å‹•å°‡ <code>I/O PWM Out 1~4</code> ç¶å®šè‡³ <code>Motor 1~4</code>ï¼Œä¸¦é‡å•Ÿã€‚</td>
        </tr>
        <tr>
            <td><strong>Offboard åˆ‡æ›è¢«æ‹’</strong><br>(Position missing)</td>
            <td>å®¤å…§ç„¡ GPSï¼Œé£›æ§æ‹’çµ•é€²å…¥éœ€ä½ç½®æ•¸æ“šçš„ <code>Velocity</code> æ¨¡å¼ã€‚</td>
            <td>ç¨‹å¼æ”¹ç”¨ <code>Attitude</code> (æ¨åŠ›) æ§åˆ¶ã€‚<br>QGC åƒæ•¸ <code>COM_ARM_WO_GPS</code> è¨­ç‚º <strong>1</strong>ã€‚</td>
        </tr>
        <tr>
            <td><strong>è§£é–è¢«æ‹’</strong><br>(Health failures)</td>
            <td>å®‰å…¨æŒ‰éˆ•æœªæŒ‰ã€USB ä¾›é›»é™åˆ¶æˆ–ç„¡é™æ§å™¨è¨Šè™Ÿã€‚</td>
            <td><code>CBRK_IO_SAFETY</code> = 22027<br><code>CBRK_USB_CHK</code> = 197848<br><code>COM_RC_IN_MODE</code> = 1</td>
        </tr>
        <tr>
            <td><strong>è§£é–å¾Œç¬é–“åœè½‰</strong></td>
            <td>é™è½åµæ¸¬å™¨èª¤åˆ¤è§¸åœ°ï¼Œç¬é–“å¼·åˆ¶åˆ‡æ–·æ¨åŠ›ã€‚</td>
            <td><code>COM_DISARM_LAND</code> è¨­ç‚º <strong>-1</strong>ï¼Œæˆ–åœ¨ç¨‹å¼ä¸­çµ¦äºˆçªç ´è‡¨ç•Œå€¼çš„å¤§æ¨åŠ›ã€‚</td>
        </tr>
    </table>


    <h2 id="code">å››ã€ æ ¸å¿ƒæ‰‹å‹¢æ§åˆ¶ç¨‹å¼ç¢¼ (Attitude æ¨åŠ›æœ€çµ‚ç‰ˆ)</h2>
    <p>æ­¤ä»£ç¢¼ç¹é GPS ä¾è³´ï¼Œç›´æ¥æ§åˆ¶æ¨åŠ›ï¼Œä¸¦è«‹ç¢ºä¿ <code>system_address</code> çš„ tty è¨­å‚™èˆ‡ä½ çš„å¯¦é«”æ¥å­” (AMA0 æˆ– AMA10) ä¸€è‡´ã€‚</p>
    <pre><code>import os
import time
import asyncio
import threading
import subprocess
import cv2
import numpy as np
import mediapipe as mp
from mavsdk import System
from mavsdk.offboard import Attitude, OffboardError

os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'

target_attitude = [0.0, 0.0, 0.0, 0.15] 
is_offboard_active = False

class CameraStream:
    """RPi 5 ç¡¬é«”åŠ é€Ÿå½±åƒè®€å–å™¨"""
    def __init__(self, width=640, height=480, fps=40):
        self.width, self.height = width, height
        self.frame_size = int(width * height * 1.5)
        self.cmd = ["rpicam-vid", "-t", "0", "--width", str(width), "--height", str(height),
                    "--framerate", str(fps), "--codec", "yuv420", "--nopreview", "-o", "-"]
        self.process = subprocess.Popen(self.cmd, stdout=subprocess.PIPE, stderr=subprocess.DEVNULL)
        self.latest_frame_rgb = None
        self.running = True
        self.thread = threading.Thread(target=self._update, daemon=True)
        self.thread.start()

    def _update(self):
        while self.running:
            raw_data = self.process.stdout.read(self.frame_size)
            if len(raw_data) == self.frame_size:
                yuv = np.frombuffer(raw_data, dtype=np.uint8).reshape((int(self.height * 1.5), self.width))
                self.latest_frame_rgb = cv2.cvtColor(yuv, cv2.COLOR_YUV2RGB_I420)

    def read(self): return self.latest_frame_rgb
    def release(self):
        self.running = False
        self.process.terminate()

async def drone_control_loop(drone):
    """ç¶­æŒ 20Hz æ§åˆ¶éˆè·¯"""
    global target_attitude
    while True:
        try:
            await drone.offboard.set_attitude(
                Attitude(target_attitude[0], target_attitude[1], target_attitude[2], target_attitude[3])
            )
        except: pass
        await asyncio.sleep(0.05)

def get_fingers_count(hand_lms, label):
    fingers = []
    if label == "Right": fingers.append(hand_lms.landmark[4].x &lt; hand_lms.landmark[3].x)
    else: fingers.append(hand_lms.landmark[4].x &gt; hand_lms.landmark[3].x)
    for tip_id in [8, 12, 16, 20]: fingers.append(hand_lms.landmark[tip_id].y &lt; hand_lms.landmark[tip_id-2].y)
    return sum(fingers)

async def run():
    global target_attitude, is_offboard_active
    drone = System()
    
    # âš ï¸ éœ€ä¾ç…§ç¡¬é«”æ¥ç·šé¸æ“‡å°æ‡‰çš„ tty æ¥å£ (AMA0 ç‚º Debug Port, AMA10 ç‚º GPIO æ’é‡)
    print("æ­£åœ¨é€£ç·šè‡³ Pixhawk 6C (Baud: 921600)...")
    await drone.connect(system_address="serial:///dev/ttyAMA0:921600") 
    
    async for state in drone.core.connection_state():
        if state.is_connected:
            print("âœ… ç„¡äººæ©Ÿå·²é€£ç·šï¼")
            break

    asyncio.create_task(drone_control_loop(drone))

    mp_hands = mp.solutions.hands
    hands = mp_hands.Hands(max_num_hands=1, model_complexity=0, min_detection_confidence=0.6)
    cap = CameraStream(640, 480, 40)
    pTime, avg_fps, status_text = 0, 0, "STANDBY"

    print("\nğŸš€ ç³»çµ±å°±ç·’ï¼šè«‹å…ˆç”¨ RC è§£é–ï¼ŒæŒ‰ 'a' éµ AI æ¥ç®¡")
    
    try:
        while True:
            frame_rgb = cap.read()
            if frame_rgb is None:
                await asyncio.sleep(0.001)
                continue

            frame_rgb = cv2.flip(frame_rgb, 1)
            results = hands.process(frame_rgb)
            frame_bgr = cv2.cvtColor(frame_rgb, cv2.COLOR_RGB2BGR)
            
            new_att = [0.0, 0.0, 0.0, 0.15] 
            
            if results and results.multi_hand_landmarks:
                for i, hand_lms in enumerate(results.multi_hand_landmarks):
                    mp.solutions.drawing_utils.draw_landmarks(frame_bgr, hand_lms, mp_hands.HAND_CONNECTIONS)
                    label = results.multi_handedness[i].classification[0].label
                    count = get_fingers_count(hand_lms, label)

                    if count == 5: 
                        new_att[3] = 0.5 
                        status_text = "CLIMBING (Thrust 50%)"
                    elif count == 0: 
                        new_att[3] = 0.05 
                        status_text = "DESCENDING (Thrust 5%)"
                    elif count == 1:
                        new_att[0] = 15.0 
                        new_att[3] = 0.2  
                        status_text = "MOVE RIGHT (Roll 15deg)"
                    else: 
                        new_att[3] = 0.15
                        status_text = "HOVERING (Idle)"
            else: 
                status_text = "SEARCHING..."
            
            target_attitude = new_att
            
            cTime = time.time()
            if (cTime - pTime) &gt; 0:
                avg_fps = (avg_fps * 0.9) + ((1 / (cTime - pTime)) * 0.1)
                pTime = cTime
            
            cv2.putText(frame_bgr, f"MODE: {'OFFBOARD (AI)' if is_offboard_active else 'RC MANUAL'}", (10, 30), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 0, 255) if is_offboard_active else (0, 255, 255), 2)
            cv2.putText(frame_bgr, f"ACTION: {status_text}", (10, 60), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)
            cv2.imshow('Marlon Drone AI', frame_bgr)
            
            key = cv2.waitKey(1) & 0xFF
            if key == ord('a'):
                print(">>> å˜—è©¦æ¥ç®¡æ§åˆ¶æ¬Š...")
                try:
                    await drone.offboard.start()
                    is_offboard_active = True
                    print("âœ… æ¥ç®¡æˆåŠŸï¼å·²åˆ‡æ›è‡³ AI æ‰‹å‹¢æ§åˆ¶ã€‚")
                except OffboardError as e:
                    print(f"âŒ æ¥ç®¡å¤±æ•—: {e._result.result}")
            elif key == ord('q'): break
            await asyncio.sleep(0.001)

    finally:
        cap.release()
        cv2.destroyAllWindows()

if __name__ == "__main__":
    asyncio.run(run())
</code></pre>

</body>
</html>
