<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UAS R&D Hub (繁體中文工程版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #020617;
            color: #cbd5e1;
        }

        .mono-font { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* ==================== 功能樣式 ==================== */
        
        #reading-progress { position: fixed; top: 0; left: 0; height: 3px; background: linear-gradient(90deg, #38bdf8, #10b981); z-index: 9999; transition: width 0.2s ease; width: 0%; }

        #back-to-top { position: fixed; bottom: 2rem; right: 2rem; width: 3rem; height: 3rem; background: #0ea5e9; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transform: translateY(100px); transition: all 0.3s ease; z-index: 1000; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4); }
        #back-to-top.visible { opacity: 1; transform: translateY(0); }
        #back-to-top:hover { background: #0284c7; transform: translateY(-4px); }

        .search-container { position: relative; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; margin-top: 0.5rem; max-height: 400px; overflow-y: auto; z-index: 50; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); }
        .search-result-item { padding: 0.75rem 1rem; border-bottom: 1px solid #334155; cursor: pointer; transition: all 0.2s; }
        .search-result-item:hover { background: #334155; padding-left: 1.5rem; }
        .search-highlight { background: rgba(56, 189, 248, 0.3); padding: 2px 4px; border-radius: 2px; }

        .bookmark-badge { position: absolute; top: 1rem; right: 1rem; cursor: pointer; font-size: 1.5rem; color: #64748b; transition: all 0.2s; z-index: 10; }
        .bookmark-badge:hover { color: #fbbf24; transform: scale(1.2); }
        .bookmark-badge.bookmarked { color: #fbbf24; }

        .theme-toggle { width: 3rem; height: 1.5rem; background: #334155; border-radius: 9999px; position: relative; cursor: pointer; transition: background 0.3s; }
        .theme-toggle.active { background: #0ea5e9; }
        .theme-toggle-slider { position: absolute; top: 2px; left: 2px; width: 1.25rem; height: 1.25rem; background: white; border-radius: 50%; transition: transform 0.3s; }
        .theme-toggle.active .theme-toggle-slider { transform: translateX(1.5rem); }

        .tour-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 9998; display: none; }
        .tour-overlay.active { display: block; }
        .tour-tooltip { position: fixed; background: #1e293b; border: 2px solid #38bdf8; border-radius: 8px; padding: 1.5rem; max-width: 350px; z-index: 10000; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); }
        .tour-btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
        .tour-btn-primary { background: #0ea5e9; color: white; }
        .tour-btn-secondary { background: #334155; color: #cbd5e1; }

        /* ==================== 組件樣式 ==================== */
        .chart-container { position: relative; width: 100%; height: 300px; max-height: 400px; }
        .nav-item.active { background-color: rgba(14, 165, 233, 0.15); color: #38bdf8; border-left: 3px solid #38bdf8; }
        
        .interactive-card, .port-connector, .topo-block, .tool-card { transition: all 0.2s ease; cursor: pointer; border: 1px solid #334155; min-height: 44px; }
        .interactive-card:hover, .port-connector:hover, .topo-block:hover, .tool-card:hover { transform: translateY(-2px); box-shadow: 0 0 15px rgba(56, 189, 248, 0.15); border-color: #38bdf8; background-color: rgba(30, 41, 59, 0.8); }

        .hw-block { border: 1px solid #334155; transition: all 0.2s ease; }
        .hw-block:hover { border-color: #38bdf8; box-shadow: 0 0 20px rgba(56, 189, 248, 0.1); transform: translateY(-2px); }

        .pin-table th { text-align: left; padding: 0.5rem; color: #94a3b8; font-size: 0.7rem; text-transform: uppercase; border-bottom: 1px solid #334155; }
        .pin-table td { padding: 0.5rem; border-bottom: 1px solid #1e293b; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: #cbd5e1; }
        
        .voltage-tag { padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; margin-right: 4px; display: inline-block;}
        .v-5 { background: rgba(244, 63, 94, 0.15); color: #fb7185; border: 1px solid rgba(244, 63, 94, 0.3); }
        .v-33 { background: rgba(56, 189, 248, 0.15); color: #38bdf8; border: 1px solid rgba(56, 189, 248, 0.3); }
        .v-gnd { background: rgba(148, 163, 184, 0.15); color: #94a3b8; border: 1px solid rgba(148, 163, 184, 0.3); }

        .bit-box { transition: all 0.2s; }
        .bit-box:hover { transform: scale(1.15); z-index: 10; box-shadow: 0 0 10px currentColor; }

        .roadmap-item { position: relative; padding-left: 2rem; padding-bottom: 2rem; border-left: 2px solid #334155; }
        .roadmap-item:last-child { border-left: 2px solid transparent; }
        .roadmap-dot { position: absolute; left: -0.55rem; top: 0; width: 1rem; height: 1rem; border-radius: 50%; background-color: #0f172a; border: 2px solid #38bdf8; }

        .foc-step { position: relative; }
        .foc-step::after { content: '➜'; position: absolute; right: -20px; top: 50%; transform: translateY(-50%); color: #475569; font-size: 1.2rem; }
        .foc-step:last-child::after { display: none; }
        @media (max-width: 768px) { .foc-step::after { right: 50%; top: auto; bottom: -25px; transform: translateX(50%) rotate(90deg); } }

        .source-badge { display: inline-flex; align-items: center; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .badge-holybro { background-color: rgba(234, 88, 12, 0.1); border: 1px solid rgba(234, 88, 12, 0.3); color: #fb923c; }
        .badge-teardown { background-color: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: #34d399; }
        .badge-standard { background-color: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #60a5fa; }
        .badge-datasheet { background-color: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); color: #c084fc; }
        .badge-design { background-color: rgba(236, 72, 153, 0.1); border: 1px solid rgba(236, 72, 153, 0.3); color: #f472b6; }
        .badge-software { background-color: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); color: #818cf8; }
        .badge-aiot { background-color: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); color: #a78bfa; }

        .chip-pkg { position: relative; background: #1e293b; border: 2px solid #475569; border-radius: 4px; }
        .chip-pin { width: 6px; height: 2px; background: #64748b; position: absolute; }
        
        .io-flow-container { position: relative; display: flex; align-items: center; justify-content: space-between; font-size: 0.75rem; }
        .io-box { padding: 0.5rem; border-radius: 4px; border: 1px solid #475569; background: #1e293b; text-align: center; font-weight: bold; width: 22%; }
        .io-arrow { color: #64748b; font-size: 1rem; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease; }
    </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen">

    <div id="reading-progress"></div>
    <div id="back-to-top"><i class="fa-solid fa-arrow-up"></i></div>
    <div id="tour-overlay" class="tour-overlay"></div>

    <!-- Mobile Header -->
    <div class="md:hidden bg-slate-900 border-b border-slate-800 p-4 flex justify-between items-center sticky top-0 z-50">
        <h1 class="font-bold text-lg text-slate-100"><i class="fa-solid fa-code mr-2"></i>UAS R&D Hub</h1>
        <button id="mobile-menu-btn" class="text-slate-400 focus:outline-none text-2xl">☰</button>
    </div>

    <!-- Sidebar -->
    <nav id="sidebar" class="hidden md:flex flex-col w-64 bg-slate-900 border-r border-slate-800 h-screen sticky top-0 z-40 overflow-y-auto">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-xl font-bold text-slate-100 tracking-tight mono-font">UAS<span class="text-sky-500">_Dev</span></h1>
            <p class="text-xs text-slate-500 mt-1">繁體中文工程版 (TC Edition)</p>
        </div>

        <div class="p-4 border-b border-slate-800 search-container">
            <div class="relative">
                <input type="text" id="search-input" placeholder="搜尋技術文件..." class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-200 focus:outline-none focus:border-sky-500 transition">
                <i class="fa-solid fa-search absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 text-sm"></i>
            </div>
            <div id="search-results" class="search-results hidden"></div>
        </div>

        <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between">
            <span class="text-xs text-slate-500">深色模式</span>
            <div class="theme-toggle active" id="theme-toggle"><div class="theme-toggle-slider"></div></div>
        </div>

        <div class="px-4 py-3 border-b border-slate-800">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-bold text-slate-500 uppercase">我的書籤</span>
                <span id="bookmark-count" class="text-xs text-sky-400">0</span>
            </div>
            <div id="bookmark-list" class="space-y-1 text-xs"></div>
        </div>

        <div class="flex-1 py-4 space-y-1">
            <!-- Strategic -->
            <div class="px-4 py-2 text-xs font-bold text-slate-600 uppercase tracking-wider">戰略規劃 (Strategic)</div>
            <a href="#" data-section="section-roadmap" class="nav-item block px-6 py-3 text-sm font-medium text-orange-400 hover:bg-slate-800 hover:text-orange-200 border-l-4 border-transparent transition-colors active bg-orange-900/10"><i class="fa-solid fa-chess-knight mr-2 w-4"></i>技術路線圖 (Roadmap)</a>
            <a href="#" data-section="section-teardown" class="nav-item block px-6 py-3 text-sm font-medium text-emerald-400 hover:bg-slate-800 hover:text-emerald-200 border-l-4 border-transparent transition-colors"><i class="fa-solid fa-box-open mr-2 w-4"></i>X500 硬體拆解 (Ref)</a>

            <!-- Hardware Deep Dive -->
            <div class="px-4 py-2 mt-4 text-xs font-bold text-slate-600 uppercase tracking-wider">硬體工程 (Hardware)</div>
            <a href="#" data-section="section-mcu" class="nav-item block px-6 py-3 text-sm font-medium text-purple-400 hover:bg-slate-800 hover:text-purple-200 border-l-4 border-transparent transition-colors"><i class="fa-solid fa-microchip mr-2 w-4"></i>MCU 架構詳解 (Chips)</a>
            <a href="#" data-section="section-design" class="nav-item block px-6 py-3 text-sm font-medium text-pink-400 hover:bg-slate-800 hover:text-pink-200 border-l-4 border-transparent transition-colors"><i class="fa-solid fa-compass-drafting mr-2 w-4"></i>自製指南 (Design)</a>
            <a href="#" data-section="section-pixhawk" class="nav-item block px-6 py-3 text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-slate-200 border-l-4 border-transparent transition-colors"><i class="fa-solid fa-server mr-2 w-4"></i>Pixhawk 6X vs 6C</a>
            <a href="#" data-section="section-bldc" class="nav-item block px-6 py-3 text-sm font-medium text-sky-400 hover:bg-slate-800 hover:text-sky-200 border-l-4 border-transparent transition-colors"><i class="fa-solid fa-bolt mr-2 w-4"></i>BLDC 馬達實驗室 (Full)</a>
            <a href="#" data-section="section-hardware" class="nav-item block px-6 py-3 text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-slate-200 border-l-4 border-transparent transition-colors"><i class="fa-solid fa-dna mr-2 w-4"></i>硬體解剖 (Anatomy)</a>
            
            <!-- System & Logic -->
            <div class="px-4 py-2 mt-4 text-xs font-bold text-slate-600 uppercase tracking-wider">控制與邏輯 (Logic)</div>
            <a href="#" data-section="section-intro" class="nav-item block px-6 py-3 text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-slate-200 border-l-4 border-transparent transition-colors"><i class="fa-solid fa-chart-pie mr-2 w-4"></i>系統概觀 (Physics)</a>
            <a href="#" data-section="section-protocols" class="nav-item block px-6 py-3 text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-slate-200 border-l-4 border-transparent transition-colors"><i class="fa-solid fa-wave-square mr-2 w-4"></i>DShot 通訊時序</a>
            <a href="#" data-section="section-pid" class="nav-item block px-6 py-3 text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-slate-200 border-l-4 border-transparent transition-colors"><i class="fa-solid fa-arrow-trend-up mr-2 w-4"></i>PID 控制理論</a>
            
            <!-- Ops & Soft -->
            <div class="px-4 py-2 mt-4 text-xs font-bold text-slate-600 uppercase tracking-wider">軟體與營運 (Soft & Ops)</div>
            <a href="#" data-section="section-devenv" class="nav-item block px-6 py-3 text-sm font-medium text-indigo-400 hover:bg-slate-800 hover:text-indigo-200 border-l-4 border-transparent transition-colors"><i class="fa-solid fa-laptop-code mr-2 w-4"></i>開發環境 (Dev Env)</a>
            <a href="#" data-section="section-software" class="nav-item block px-6 py-3 text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-slate-200 border-l-4 border-transparent transition-colors"><i class="fa-brands fa-git-alt mr-2 w-4"></i>軟體棧 (Stack)</a>
            <a href="#" data-section="section-aiot" class="nav-item block px-6 py-3 text-sm font-medium text-violet-400 hover:bg-slate-800 hover:text-violet-200 border-l-4 border-transparent transition-colors"><i class="fa-solid fa-network-wired mr-2 w-4"></i>AIoT 與 ROS 2</a>
            <a href="#" data-section="section-maint" class="nav-item block px-6 py-3 text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-slate-200 border-l-4 border-transparent transition-colors"><i class="fa-solid fa-wrench mr-2 w-4"></i>故障診斷 (Debug)</a>
            <a href="#" data-section="section-resources" class="nav-item block px-6 py-3 text-sm font-medium text-teal-400 hover:bg-slate-800 hover:text-teal-200 border-l-4 border-transparent transition-colors"><i class="fa-solid fa-coins mr-2 w-4"></i>資源與成本 (Resources)</a>
        </div>

        <div class="p-4 border-t border-slate-800">
            <button onclick="startTour()" class="w-full bg-sky-600 hover:bg-sky-500 text-white py-2 rounded text-sm font-bold transition"><i class="fa-solid fa-route mr-2"></i>開始導覽</button>
        </div>
        <div class="p-4 bg-slate-950 border-t border-slate-800 text-xs text-slate-500">Engineer: Marlon</div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-10 overflow-x-hidden">

        <!-- 1. Roadmap -->
        <section id="section-roadmap" class="mb-16 animate-section relative">
            <i class="fa-regular fa-bookmark bookmark-badge" data-bookmark="section-roadmap"></i>
            <header class="mb-8 border-b border-slate-800 pb-4">
                <h2 class="text-3xl font-bold text-slate-100 mb-2">技術前瞻 (Tech Roadmap)</h2>
                <div class="flex items-center gap-2 text-slate-400 text-sm">
                    <span class="source-badge badge-holybro">官方來源</span><span>Holybro CTO @ PX4 Summit</span>
                </div>
            </header>
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="bg-slate-950 p-6 rounded-xl border border-slate-800">
                    <h3 class="text-lg font-bold text-slate-200 mb-6 flex items-center"><i class="fa-solid fa-timeline mr-2 text-orange-500"></i>次世代航電架構</h3>
                    <div class="pl-2 space-y-6 border-l-2 border-slate-800 ml-2">
                        <div class="roadmap-item">
                            <div class="roadmap-dot border-orange-500"></div>
                            <h4 class="text-base font-bold text-orange-400">FMURT7 (i.MX RT1176)</h4>
                            <p class="text-sm text-slate-400 mt-1">1GHz 雙核心 (Cortex-M7/M4)。突破 STM32 的效能瓶頸,原生支援乙太網 (Ethernet),適合邊緣 AI 計算。</p>
                        </div>
                        <div class="roadmap-item">
                            <div class="roadmap-dot border-sky-500"></div>
                            <h4 class="text-base font-bold text-sky-400">PAB 標準 (Pixhawk Autopilot Bus)</h4>
                            <p class="text-sm text-slate-400 mt-1">模組化設計標準。將「飛控核心 (Core)」與「載板 (Baseboard)」分離,實現硬體熱插拔升級。</p>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-lg">
                    <h4 class="font-bold text-slate-200 mb-3 text-sm uppercase tracking-wider">高階周邊設備</h4>
                    <div class="space-y-3">
                        <div class="bg-slate-950 p-3 rounded border border-slate-700">
                            <strong class="text-slate-300 text-sm block">Unicore UM982 (雙天線 RTK)</strong>
                            <p class="text-xs text-slate-500 mt-1">支援 GPS Heading (雙天線定航向)。在高壓電塔或大型金屬結構旁,可完全免疫磁羅盤干擾。</p>
                        </div>
                        <div class="bg-slate-950 p-3 rounded border border-slate-700">
                            <strong class="text-slate-300 text-sm block">PM08D (200A 數位電流計)</strong>
                            <p class="text-xs text-slate-500 mt-1">I2C 數位傳輸。專為 14S 高壓農業機與物流無人機設計。</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. Teardown -->
        <section id="section-teardown" class="mb-16 hidden animate-section relative">
            <i class="fa-regular fa-bookmark bookmark-badge" data-bookmark="section-teardown"></i>
            <header class="mb-8 border-b border-slate-800 pb-4">
                <h2 class="text-3xl font-bold text-slate-100 mb-2">X500 V2 硬體拆解 (Hardware Teardown)</h2>
                <div class="flex items-center gap-2 text-slate-400 text-sm">
                    <span class="source-badge badge-teardown">實機拆解</span>
                    <span>Holybro X500 V2 Kit</span>
                </div>
            </header>
            <div class="grid md:grid-cols-2 gap-6 mb-8">
                <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
                    <h3 class="text-xl font-bold text-emerald-400 mb-4 flex items-center"><i class="fa-solid fa-microchip mr-2"></i>飛控系統</h3>
                    <div class="space-y-3 text-sm text-slate-300">
                        <div class="flex justify-between py-2 border-b border-slate-800"><span class="text-slate-500">飛控:</span><span class="font-bold">Pixhawk 6C</span></div>
                        <div class="flex justify-between py-2 border-b border-slate-800"><span class="text-slate-500">MCU:</span><span class="font-mono text-xs">STM32H743 @ 480MHz</span></div>
                        <div class="flex justify-between py-2 border-b border-slate-800"><span class="text-slate-500">IMU:</span><span>ICM-42688-P + BMI088</span></div>
                        <div class="flex justify-between py-2"><span class="text-slate-500">GPS:</span><span>M9N (u-blox)</span></div>
                    </div>
                </div>
                <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
                    <h3 class="text-xl font-bold text-sky-400 mb-4 flex items-center"><i class="fa-solid fa-bolt mr-2"></i>動力系統</h3>
                    <div class="space-y-3 text-sm text-slate-300">
                        <div class="flex justify-between py-2 border-b border-slate-800"><span class="text-slate-500">馬達:</span><span class="font-bold">2216 KV880</span></div>
                        <div class="flex justify-between py-2 border-b border-slate-800"><span class="text-slate-500">ESC:</span><span>BLHeli_S 20A (DShot)</span></div>
                        <div class="flex justify-between py-2 border-b border-slate-800"><span class="text-slate-500">螺旋槳:</span><span>10" 碳纖維</span></div>
                        <div class="flex justify-between py-2"><span class="text-slate-500">電池:</span><span>4S 5200mAh LiPo</span></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. MCU Deep Dive -->
        <section id="section-mcu" class="mb-16 hidden animate-section relative">
            <i class="fa-regular fa-bookmark bookmark-badge" data-bookmark="section-mcu"></i>
            <header class="mb-8 border-b border-slate-800 pb-4">
                <h2 class="text-3xl font-bold text-slate-100 mb-2">STM32 晶片架構詳解 (MCU Deep Dive)</h2>
                <div class="flex items-center gap-2 text-slate-400 text-sm">
                    <span class="source-badge badge-datasheet">Datasheet</span>
                    <span>STM32H753 / H743 / F103</span>
                </div>
            </header>
            <div class="grid lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center"><i class="fa-solid fa-brain mr-2 text-purple-500"></i>主飛控核心 (FMU): H7 系列</h3>
                    <div class="space-y-6">
                        <div class="bg-slate-950 p-4 rounded-lg border border-slate-700">
                            <div class="grid grid-cols-2 gap-4 border-b border-slate-800 pb-2 mb-2">
                                <div><h4 class="text-emerald-400 font-bold">STM32H753</h4><span class="text-xs text-slate-500">Pixhawk 6X (企業級)</span></div>
                                <div><h4 class="text-sky-400 font-bold">STM32H743</h4><span class="text-xs text-slate-500">Pixhawk 6C (標準級)</span></div>
                            </div>
                            <ul class="text-sm text-slate-300 space-y-2 list-disc list-inside">
                                <li><strong>運算核心:</strong> Cortex-M7 @ 480MHz (2144 CoreMark)。</li>
                                <li><strong>AXI Bus Matrix:</strong> 確保 RAM 與週邊 (Ethernet/SDMMC) 的併發存取不塞車。</li>
                                <li><strong>差異點 (Security):</strong> <br><span class="text-emerald-400">H753</span> 獨有硬體加密引擎 (Crypto/Hash),支援高強度 Secure Boot 防篡改。</li>
                            </ul>
                        </div>
                        <div class="bg-slate-800 p-3 rounded text-xs text-slate-400 border-l-4 border-purple-500">
                            <strong>DMA 架構重點:</strong>H7 具備 MDMA (Master DMA),可在不佔用 CPU 情況下,自主搬運大量感測器 SPI 數據到 RAM,這是高頻率 (8kHz Loop) 運作的關鍵。
                        </div>
                    </div>
                </div>
                <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center"><i class="fa-solid fa-shield-halved mr-2 text-rose-500"></i>IO 協處理器 (STM32F103)</h3>
                    <div class="bg-slate-950 p-4 rounded-lg border border-slate-700 h-full">
                        <div class="mb-4 pb-2 border-b border-slate-800">
                            <h4 class="text-rose-400 font-bold">PX4IO 架構 (Safety Island)</h4>
                            <span class="text-xs text-slate-500">目的:當主核 (H7) 當機時,確保飛機仍受控制。</span>
                        </div>
                        <div class="io-flow-container mb-6 bg-slate-900 p-2 rounded border border-slate-800">
                            <div class="io-box border-emerald-900 text-emerald-400">RC Input<br><span class="text-[10px] text-slate-500">SBUS/PPM</span></div>
                            <i class="fa-solid fa-arrow-right io-arrow"></i>
                            <div class="io-box border-rose-900 text-rose-400">F103 IO<br><span class="text-[10px] text-slate-500">Mixing/Mux</span></div>
                            <i class="fa-solid fa-arrow-right io-arrow"></i>
                            <div class="io-box border-sky-900 text-sky-400">Main Out<br><span class="text-[10px] text-slate-500">PWM 1-8</span></div>
                        </div>
                        <div class="space-y-4 text-sm text-slate-300">
                            <div>
                                <strong class="text-white block mb-1">關鍵功能:</strong>
                                <ul class="list-none space-y-3 mt-2">
                                    <li class="relative pl-4 border-l-2 border-emerald-500"><strong class="text-emerald-300 text-xs uppercase block">1. RC Decoding</strong> 負責繁重的中斷解碼,減輕 H7 負擔。</li>
                                    <li class="relative pl-4 border-l-2 border-rose-500"><strong class="text-rose-300 text-xs uppercase block">2. Failsafe Mux</strong> 若 H7 心跳停止,IO 自動切換 RC 直通模式 (Manual Override)。</li>
                                    <li class="relative pl-4 border-l-2 border-amber-500"><strong class="text-amber-300 text-xs uppercase block">3. FMU Link (1.5Mbps)</strong> 專用二進制協議,CRC 校驗,500ms Watchdog 機制。</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. Design Guide -->
        <section id="section-design" class="mb-16 hidden animate-section relative">
            <i class="fa-regular fa-bookmark bookmark-badge" data-bookmark="section-design"></i>
            <header class="mb-8 border-b border-slate-800 pb-4">
                <h2 class="text-3xl font-bold text-slate-100 mb-2">自製硬體指南 (Hardware Design Guide)</h2>
                <div class="flex items-center gap-2 text-slate-400 text-sm">
                    <span class="source-badge badge-design">Reference Design</span>
                    <span>相容 FMUv6C 標準</span>
                </div>
            </header>
            <div class="bg-amber-900/10 border border-amber-800 p-4 rounded-lg mb-8 flex items-start">
                <i class="fa-solid fa-circle-exclamation text-amber-500 mt-1 mr-3"></i>
                <div class="text-sm text-slate-300">
                    <strong class="text-amber-400 block mb-1">關於 Pixhawk 6C 原理圖</strong>
                    <p>Holybro 官方並未公開 6C 的完整原理圖 (SCH)。建議採用 <strong>FMUv6C 標準 + 開源參考設計 (如 Pix32 v6)</strong> 的策略。下方提供實作導向的模組拆解。</p>
                </div>
            </div>
            <div class="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden mb-8">
                <div class="flex border-b border-slate-800 bg-slate-950 overflow-x-auto">
                    <button onclick="showDesignTab('modules')" id="tab-modules" class="px-6 py-4 text-sm font-bold text-pink-400 bg-slate-900 border-r border-slate-800 transition whitespace-nowrap">模組拆解清單</button>
                    <button onclick="showDesignTab('pinout')" id="tab-pinout" class="px-6 py-4 text-sm font-bold text-slate-500 bg-slate-950 transition whitespace-nowrap">H743 Pin Mapping (一體板)</button>
                </div>
                <div id="content-modules" class="p-6 md:p-8 animate-fade-in">
                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="text-sky-400 font-bold mb-3 border-b border-sky-900 pb-2">1. 核心與 IO (Core)</h4>
                            <ul class="space-y-3 text-sm text-slate-400">
                                <li><strong class="text-white">FMU:</strong> STM32H743ZIT6 (LQFP144)。外掛 QSPI Flash (儲存)、FRAM (參數)。</li>
                                <li><strong class="text-white">IO MCU:</strong> STM32F103C8T6。負責 PWM 輸出與 RC 解碼。</li>
                            </ul>
                            <h4 class="text-emerald-400 font-bold mb-3 mt-6 border-b border-emerald-900 pb-2">2. 感測器 (Sensors)</h4>
                            <ul class="space-y-3 text-sm text-slate-400">
                                <li><strong class="text-white">IMU 1 (SPI):</strong> ICM-42688-P (高頻震動性能佳)。</li>
                                <li><strong class="text-white">IMU 2 (SPI):</strong> BMI088 (工業級穩定性)。</li>
                                <li><strong class="text-white">Mag (I2C):</strong> IST8310 (外部 I2C 磁羅盤)。</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="text-rose-400 font-bold mb-3 border-b border-rose-900 pb-2">3. 電源架構 (Power)</h4>
                            <ul class="space-y-3 text-sm text-slate-400">
                                <li><strong class="text-white">輸入冗餘:</strong> POWER1 / POWER2 / USB 三路輸入 (Ideal Diode OR-ing)。</li>
                                <li><strong class="text-white">電壓軌:</strong> 5V (主供電), 3.3V_FMU, 3.3V_SENSORS (分開 LDO)。</li>
                            </ul>
                            <h4 class="text-amber-400 font-bold mb-3 mt-6 border-b border-amber-900 pb-2">4. 通訊與接口 (Comms)</h4>
                            <ul class="space-y-3 text-sm text-slate-400">
                                <li><strong class="text-white">Connectors:</strong> JST-GH 1.25mm (Pixhawk 標準)。</li>
                                <li><strong class="text-white">CAN:</strong> 2x CAN-FD (需外掛 Transceiver)。</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div id="content-pinout" class="hidden p-6 md:p-8 animate-fade-in">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse text-sm">
                            <thead><tr class="bg-slate-800 text-slate-200"><th class="p-3 border-b border-slate-700">Port Name</th><th class="p-3 border-b border-slate-700">MCU Pin</th><th class="p-3 border-b border-slate-700">STM32 Function</th><th class="p-3 border-b border-slate-700">Connector (JST-GH)</th></tr></thead>
                            <tbody class="text-slate-400 font-mono">
                                <tr class="border-b border-slate-800 hover:bg-slate-800/50"><td class="p-3 text-emerald-400 font-bold">GPS 1</td><td class="p-3">PA9 / PA10</td><td class="p-3">USART1_TX / RX</td><td class="p-3">10-Pin</td></tr>
                                <tr class="border-b border-slate-800 hover:bg-slate-800/50"><td class="p-3 text-sky-400 font-bold">TELEM 1</td><td class="p-3">PE7 / PE8</td><td class="p-3">UART7_TX / RX</td><td class="p-3">6-Pin</td></tr>
                                <tr class="border-b border-slate-800 hover:bg-slate-800/50"><td class="p-3 text-sky-400">TELEM 2</td><td class="p-3">PC12 / PD2</td><td class="p-3">UART5_TX / RX</td><td class="p-3">6-Pin</td></tr>
                                <tr class="border-b border-slate-800 bg-slate-800/30"><td class="p-3 text-rose-400">IO LINK (Internal)</td><td class="p-3">PC6 / PC7</td><td class="p-3">USART6_TX / RX</td><td class="p-3">To STM32F103</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. Pixhawk Comparison -->
        <section id="section-pixhawk" class="mb-16 hidden animate-section relative">
            <i class="fa-regular fa-bookmark bookmark-badge" data-bookmark="section-pixhawk"></i>
            <header class="mb-8 border-b border-slate-800 pb-4">
                <h2 class="text-3xl font-bold text-slate-100 mb-2">Pixhawk 6X/6C 硬體標準對照</h2>
                <div class="flex items-center gap-2 text-slate-400 text-sm"><span class="source-badge badge-standard">DS-012/018</span></div>
            </header>
            <div class="grid lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-slate-900 p-6 rounded-xl border border-slate-800">
                    <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">Port Pinout (6X 載板參考)</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="port-connector bg-slate-900/50 p-3 rounded text-center" data-port="power"><div class="port-label text-rose-400">POWER 1 & 2</div><i class="fa-solid fa-battery-full text-xl text-rose-500 my-2"></i></div>
                        <div class="port-connector bg-slate-900/50 p-3 rounded text-center" data-port="gps"><div class="port-label text-emerald-400">GPS 1 & 2</div><i class="fa-solid fa-satellite text-xl text-emerald-500 my-2"></i></div>
                        <div class="port-connector bg-slate-900/50 p-3 rounded text-center" data-port="telem"><div class="port-label text-sky-400">TELEM 1-3</div><i class="fa-solid fa-wifi text-xl text-sky-500 my-2"></i></div>
                        <div class="port-connector bg-slate-900/50 p-3 rounded text-center" data-port="fmu_pwm"><div class="port-label text-amber-400">FMU PWM</div><i class="fa-solid fa-fan text-xl text-amber-500 my-2"></i></div>
                        <div class="port-connector bg-slate-900/50 p-3 rounded text-center" data-port="io_pwm"><div class="port-label text-slate-300">IO PWM</div><i class="fa-solid fa-gears text-xl text-slate-400 my-2"></i></div>
                        <div class="port-connector bg-slate-900/50 p-3 rounded text-center" data-port="can"><div class="port-label text-indigo-400">CAN 1 & 2</div><i class="fa-solid fa-network-wired text-xl text-indigo-500 my-2"></i></div>
                    </div>
                </div>
                <div class="lg:col-span-1">
                    <div id="port-detail-panel" class="bg-slate-900 border border-slate-700 h-full rounded-xl p-6 shadow-lg animate-fade-in flex flex-col">
                        <div class="flex items-center mb-4 pb-4 border-b border-slate-800"><div id="port-icon" class="text-2xl mr-3"></div><div><h4 id="port-title" class="text-xl font-bold text-white">請選擇接口</h4></div></div>
                        <div id="port-content" class="text-sm text-slate-400 flex-1 overflow-y-auto"><p class="italic opacity-70">點擊左側圖表以查看詳細電氣規格。</p></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 6. BLDC -->
        <section id="section-bldc" class="mb-16 hidden animate-section relative">
            <i class="fa-regular fa-bookmark bookmark-badge" data-bookmark="section-bldc"></i>
            <header class="mb-8 border-b border-slate-800 pb-4">
                <h2 class="text-3xl font-bold text-slate-100 mb-2">BLDC 馬達控制板實驗室</h2>
                <div class="flex items-center gap-2 text-slate-400 text-sm"><span class="source-badge badge-datasheet">FOC + DShot</span></div>
            </header>
            <div class="bg-slate-950 p-6 rounded-xl border border-slate-800 shadow-inner mb-8 overflow-x-auto">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">逆變器拓撲 (Inverter Topology)</h3>
                <div class="flex flex-col md:flex-row gap-4 items-stretch min-w-[700px]">
                    <div class="topo-block flex-1 bg-slate-900 rounded-lg p-4 cursor-pointer relative" onclick="showBldcDetail('mcu')"><div class="text-center mt-2"><i class="fa-solid fa-microchip text-3xl text-sky-500 mb-2"></i><h4 class="font-bold text-slate-200">STM32 G4</h4></div></div>
                    <div class="flex items-center justify-center text-slate-600"><i class="fa-solid fa-arrow-right-long text-xl"></i></div>
                    <div class="topo-block flex-1 bg-slate-900 rounded-lg p-4 cursor-pointer relative" onclick="showBldcDetail('driver')"><div class="text-center mt-2"><i class="fa-solid fa-charging-station text-3xl text-amber-500 mb-2"></i><h4 class="font-bold text-slate-200">Gate Driver</h4></div></div>
                    <div class="flex items-center justify-center text-slate-600"><i class="fa-solid fa-arrow-right-long text-xl"></i></div>
                    <div class="topo-block flex-1 bg-slate-900 rounded-lg p-4 cursor-pointer relative" onclick="showBldcDetail('mosfet')"><div class="text-center mt-2"><i class="fa-solid fa-bolt text-3xl text-rose-500 mb-2"></i><h4 class="font-bold text-slate-200">MOSFETs</h4></div></div>
                </div>
            </div>
            <div id="bldc-detail-box" class="bg-slate-800 border border-slate-700 p-6 rounded-xl shadow-lg mb-8 hidden">
                <div class="flex items-start"><div class="mr-4 text-3xl" id="bldc-icon"></div><div class="flex-1"><h3 class="text-xl font-bold text-slate-100 mb-2" id="bldc-title"></h3><p class="text-slate-300 mb-4 text-sm" id="bldc-desc"></p><div class="bg-slate-950 p-4 rounded border border-slate-800"><h4 class="text-xs text-sky-500 font-bold uppercase mb-3">選型公式</h4><ul class="text-sm text-slate-400 mono-font space-y-3" id="bldc-specs"></ul></div></div></div>
            </div>
        </section>

        <!-- 7. Hardware Anatomy -->
        <section id="section-hardware" class="mb-16 hidden animate-section relative">
            <i class="fa-regular fa-bookmark bookmark-badge" data-bookmark="section-hardware"></i>
            <header class="mb-8 border-b border-slate-800 pb-4"><h2 class="text-3xl font-bold text-slate-100 mb-2">硬體解剖 (生理學觀點)</h2></header>
            <div class="grid md:grid-cols-4 gap-4" id="anatomy-grid"></div>
            <div id="anatomy-detail" class="mt-6 bg-slate-800/50 border border-slate-700 p-6 rounded-xl shadow-lg hidden">
                <h3 id="detail-title" class="text-xl font-bold text-sky-400 mb-2"></h3><p id="detail-desc" class="text-slate-300 mb-2"></p><div class="bg-slate-950 p-3 rounded border border-slate-800"><ul class="space-y-1 text-sm text-emerald-400 mono-font" id="detail-specs"></ul></div>
            </div>
        </section>

        <!-- 8. Intro / System Overview -->
        <section id="section-intro" class="mb-16 hidden animate-section relative">
            <i class="fa-regular fa-bookmark bookmark-badge" data-bookmark="section-intro"></i>
            <header class="mb-8 border-b border-slate-800 pb-4"><h2 class="text-3xl font-bold text-slate-100 mb-2">系統概觀 (物理特性)</h2></header>
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-lg"><div class="chart-container"><canvas id="vehicleChart"></canvas></div></div>
                <div class="space-y-4">
                    <div class="bg-slate-950 p-4 rounded border border-slate-800"><strong class="text-sky-400 block mb-1">圓盤負載 (Disk Loading)</strong><p class="text-xs text-slate-400">$$ DL = \frac{Weight}{PropArea} $$</p></div>
                    <div class="bg-slate-950 p-4 rounded border border-slate-800"><strong class="text-emerald-400 block mb-1">失速速度 (Stall Speed)</strong><p class="text-xs text-slate-400">$$ V_{stall} = \sqrt{\frac{2W}{\rho S C_{L,max}}} $$</p></div>
                </div>
            </div>
        </section>

        <!-- 9. Protocols -->
        <section id="section-protocols" class="mb-16 hidden animate-section relative">
            <i class="fa-regular fa-bookmark bookmark-badge" data-bookmark="section-protocols"></i>
            <header class="mb-8 border-b border-slate-800 pb-4"><h2 class="text-3xl font-bold text-slate-100 mb-2">DShot 通訊時序</h2></header>
            <div class="bg-slate-900 p-8 rounded-xl shadow-lg border border-slate-800">
                <div class="flex flex-wrap justify-center gap-1 mb-8" id="dshot-bits"></div>
                <div class="grid md:grid-cols-3 gap-4 text-center text-xs mono-font">
                    <div class="bg-slate-950 p-3 rounded border border-slate-700"><strong class="text-sky-400 block">DShot150</strong><span>150 kbit/s</span></div>
                    <div class="bg-slate-950 p-3 rounded border border-slate-700"><strong class="text-sky-400 block">DShot300</strong><span>300 kbit/s</span></div>
                    <div class="bg-slate-950 p-3 rounded border border-slate-700"><strong class="text-sky-400 block">DShot600</strong><span>600 kbit/s</span></div>
                </div>
            </div>
        </section>

        <!-- 10. PID -->
        <section id="section-pid" class="mb-16 hidden animate-section relative">
            <i class="fa-regular fa-bookmark bookmark-badge" data-bookmark="section-pid"></i>
            <header class="mb-8 border-b border-slate-800 pb-4"><h2 class="text-3xl font-bold text-slate-100 mb-2">PID 控制理論</h2></header>
            <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
                <div class="mb-6 bg-slate-950 p-4 rounded border border-slate-700 text-center"><p class="text-slate-300 text-sm mono-font">$$ u(t) = K_p e(t) + K_i \int_0^t e(\tau)d\tau + K_d \frac{de(t)}{dt} + FF $$</p></div>
                <div class="chart-container"><canvas id="pidChart"></canvas></div>
                <div class="flex justify-center gap-4 mt-4">
                    <button onclick="updatePidChart('balanced')" class="px-3 py-1 bg-emerald-900/30 text-emerald-400 border border-emerald-800 rounded">完美調校</button>
                    <button onclick="updatePidChart('highP')" class="px-3 py-1 bg-rose-900/30 text-rose-400 border border-rose-800 rounded">P值過高</button>
                </div>
            </div>
        </section>

        <!-- 11. Dev Environment (New Structure) -->
        <section id="section-devenv" class="mb-16 hidden animate-section relative">
            <i class="fa-regular fa-bookmark bookmark-badge" data-bookmark="section-devenv"></i>
            <header class="mb-8 border-b border-slate-800 pb-4">
                <h2 class="text-3xl font-bold text-slate-100 mb-2">開發環境建置 (Development Setup)</h2>
                <div class="flex items-center gap-2 text-slate-400 text-sm"><span class="source-badge badge-software">分層架構</span><span>Ubuntu 22.04/24.04</span></div>
            </header>

            <!-- Layer 1: MCU Tools -->
            <div class="bg-slate-900 p-6 rounded-xl border border-slate-800 mb-8">
                <h3 class="text-xl font-bold text-indigo-400 mb-4 flex items-center"><i class="fa-solid fa-layer-group mr-2"></i>第 1 層：基礎 MCU 開發工具</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-slate-400">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-950">
                            <tr><th class="px-4 py-2">工具</th><th class="px-4 py-2">用途</th><th class="px-4 py-2">優先度</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800">
                            <tr><td class="px-4 py-3 font-bold text-white">STM32CubeIDE 1.16.1+</td><td>ST 官方調試、雙核 H7 支援</td><td class="text-emerald-400">⭐⭐⭐⭐⭐</td></tr>
                            <tr><td class="px-4 py-3 font-bold text-white">STM32CubeMX 6.11.1</td><td>圖形化 Pinout 配置、FreeRTOS 生成</td><td class="text-emerald-400">⭐⭐⭐⭐⭐</td></tr>
                            <tr><td class="px-4 py-3 font-bold text-white">PlatformIO (VSCode)</td><td>輕量級開發、跨平台專案管理</td><td class="text-sky-400">⭐⭐⭐⭐</td></tr>
                            <tr><td class="px-4 py-3 font-bold text-white">arm-none-eabi-gcc 12.2+</td><td>ARM 交叉編譯器 (基礎 Toolchain)</td><td class="text-emerald-400">⭐⭐⭐⭐⭐</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Layer 3: Simulation -->
            <div class="bg-slate-900 p-6 rounded-xl border border-slate-800 mb-8">
                <h3 class="text-xl font-bold text-amber-400 mb-4 flex items-center"><i class="fa-solid fa-vr-cardboard mr-2"></i>第 3 層：仿真驗證環境 (SITL)</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-slate-950 p-4 rounded border border-slate-700">
                        <strong class="text-white block mb-2">Gazebo Ignition (推薦)</strong>
                        <p class="text-xs text-slate-400 mb-2">高保真物理引擎，支援 ROS 2 整合。</p>
                        <code class="block bg-slate-900 p-2 rounded text-emerald-400 text-xs">make px4_sitl_default gazebo</code>
                    </div>
                    <div class="bg-slate-950 p-4 rounded border border-slate-700">
                        <strong class="text-white block mb-2">jMAVSim</strong>
                        <p class="text-xs text-slate-400 mb-2">輕量級，適合快速測試演算法。</p>
                        <code class="block bg-slate-900 p-2 rounded text-sky-400 text-xs">make px4_sitl_default jmavsim</code>
                    </div>
                </div>
            </div>

            <!-- Checklist -->
            <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
                <h3 class="text-xl font-bold text-emerald-400 mb-4 flex items-center"><i class="fa-solid fa-clipboard-check mr-2"></i>無損新增實施清單</h3>
                <div class="space-y-3 text-sm text-slate-300">
                    <p>在現有環境中執行以下命令以盤點工具鏈：</p>
                    <pre class="bg-slate-950 p-3 rounded border border-slate-700 text-xs font-mono text-slate-400 overflow-x-auto">
cat > ~/uav_toolchain_manifest.txt << 'EOF'
=== UAV 開發工具鏈盤點 ===
日期: $(date)
GCC 版本: $(arm-none-eabi-gcc --version | head -n 1)
CMake 版本: $(cmake --version | head -n 1)
EOF
                    </pre>
                </div>
            </div>
        </section>

        <!-- 12. Software Stack (Enhanced) -->
        <section id="section-software" class="mb-16 hidden animate-section relative">
            <i class="fa-regular fa-bookmark bookmark-badge" data-bookmark="section-software"></i>
            <header class="mb-8 border-b border-slate-800 pb-4">
                <h2 class="text-3xl font-bold text-slate-100 mb-2">第 2 層：高層飛控軟體框架</h2>
                <div class="flex items-center gap-2 text-slate-400 text-sm"><span class="source-badge badge-software">PX4 vs ArduPilot</span></div>
            </header>

            <div class="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden mb-8">
                <div class="flex border-b border-slate-800 bg-slate-950">
                    <button id="tab-px4" onclick="switchStack('px4')" class="flex-1 py-4 font-bold text-sky-400 bg-slate-900 border-r border-slate-800 transition">PX4 Autopilot (BVLOS 推薦)</button>
                    <button id="tab-ardupilot" onclick="switchStack('ardupilot')" class="flex-1 py-4 font-bold text-slate-500 bg-slate-950 transition">ArduPilot (DIY/教育 推薦)</button>
                </div>
                
                <!-- PX4 Content -->
                <div id="content-px4" class="p-8">
                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <ul class="space-y-3 text-sm text-slate-300">
                                <li><strong>核心版本:</strong> v1.16.1 (穩定)</li>
                                <li><strong>RTOS:</strong> NuttX 11.4 (POSIX 相容)</li>
                                <li><strong>架構優勢:</strong> 
                                    <ul class="list-disc list-inside ml-4 mt-1 text-slate-400">
                                        <li>uORB 發佈-訂閱模式，低延遲</li>
                                        <li>ROS 2 XRCE-DDS 原生整合</li>
                                        <li>模組化設計，適合二次開發</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                        <div class="bg-slate-950 p-4 rounded border border-slate-700">
                            <strong class="text-sky-400 text-xs block mb-2">安裝與編譯 (Ubuntu 22.04+):</strong>
                            <code class="text-xs text-slate-400 block whitespace-pre">git clone https://github.com/PX4/PX4-Autopilot.git
bash Tools/setup/ubuntu.sh
make px4_fmu-v6c_default</code>
                        </div>
                    </div>
                </div>

                <!-- ArduPilot Content -->
                <div id="content-ardupilot" class="p-8 hidden">
                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <ul class="space-y-3 text-sm text-slate-300">
                                <li><strong>核心版本:</strong> v4.6.3 (穩定)</li>
                                <li><strong>RTOS:</strong> ChibiOS 21.x</li>
                                <li><strong>架構優勢:</strong> 
                                    <ul class="list-disc list-inside ml-4 mt-1 text-slate-400">
                                        <li>Lua 腳本支援，快速演算法迭代</li>
                                        <li>豐富的驅動支援與社群資源</li>
                                        <li>對舊硬體相容性極佳</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                        <div class="bg-slate-950 p-4 rounded border border-slate-700">
                            <strong class="text-rose-400 text-xs block mb-2">安裝與編譯 (Ubuntu 22.04+):</strong>
                            <code class="text-xs text-slate-400 block whitespace-pre">git clone https://github.com/ArduPilot/ardupilot.git
Tools/environment_install/install-prereqs-ubuntu.sh -y
./waf configure --board Pixhawk6C
./waf copter</code>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 13. AIoT & ROS 2 (NEW) -->
        <section id="section-aiot" class="mb-16 hidden animate-section relative">
            <i class="fa-regular fa-bookmark bookmark-badge" data-bookmark="section-aiot"></i>
            <header class="mb-8 border-b border-slate-800 pb-4">
                <h2 class="text-3xl font-bold text-slate-100 mb-2">AIoT 與邊緣運算層 (ROS 2 + ESP32)</h2>
                <div class="flex items-center gap-2 text-slate-400 text-sm"><span class="source-badge badge-aiot">micro-ROS</span><span>Ubuntu 22.04 + Humble</span></div>
            </header>

            <div class="grid lg:grid-cols-2 gap-8 mb-8">
                <!-- Architecture -->
                <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
                    <h3 class="text-xl font-bold text-violet-400 mb-4"><i class="fa-solid fa-sitemap mr-2"></i>系統架構</h3>
                    <div class="bg-slate-950 p-4 rounded border border-slate-700 font-mono text-xs text-slate-300 whitespace-pre leading-relaxed">
Pixhawk 6C (PX4)
    ↓ (MAVLink + UART)
伴飛電腦 (Jetson/Pi 5)
    ├─ ROS 2 Humble
    ├─ micro-ROS Agent
    │
ESP32 (邊緣節點)
    ├─ Arduino Framework
    └─ micro-ROS Client (WiFi)
                    </div>
                    <p class="text-sm text-slate-400 mt-4">應用：無線影像串流、自適應控制、TinyML 推論。</p>
                </div>

                <!-- ESP32 Code -->
                <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
                    <h3 class="text-xl font-bold text-emerald-400 mb-4"><i class="fa-solid fa-code mr-2"></i>ESP32 Client 範例</h3>
                    <pre class="bg-slate-950 p-3 rounded border border-slate-700 text-xs font-mono text-slate-400 overflow-x-auto"><code>// Arduino + micro-ROS
#include &lt;micro_ros_platformio.h&gt;
#include &lt;rcl/rcl.h&gt;
#include &lt;std_msgs/msg/float32.h&gt;

void setup() {
  set_microros_wifi_transports("SSID", "PASS", IP, 8888);
  
  rclc_node_init_default(&node, "esp32_node", "", &support);
  rclc_publisher_init_default(
    &pub, &node,
    ROSIDL_GET_MSG_TYPE_SUPPORT(std_msgs, msg, Float32),
    "sensor_data");
}</code></pre>
                </div>
            </div>

            <!-- ROS 2 Integration -->
            <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
                <h3 class="text-xl font-bold text-sky-400 mb-4"><i class="fa-brands fa-linux mr-2"></i>ROS 2 Humble + PX4 深度整合</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <strong class="text-white text-sm block mb-2">安裝步驟 (Ubuntu 22.04):</strong>
                        <ol class="list-decimal list-inside text-xs text-slate-400 space-y-1">
                            <li>安裝 ROS 2 Humble Desktop</li>
                            <li>建立工作空間 <code>~/ros2_px4_ws</code></li>
                            <li>克隆 <code>px4_ros_com</code> 與 <code>px4_msgs</code></li>
                            <li>使用 <code>colcon build</code> 編譯</li>
                            <li>啟動 <code>micro_xrce_dds_agent</code></li>
                        </ol>
                    </div>
                    <div class="bg-slate-950 p-3 rounded border border-slate-700">
                        <strong class="text-white text-xs block mb-1">啟動命令:</strong>
                        <code class="text-xs text-sky-400 block">MicroXRCEAgent udp4 -p 8888</code>
                    </div>
                </div>
            </div>
        </section>

        <!-- 14. Troubleshooting (Enhanced) -->
        <section id="section-maint" class="mb-16 hidden animate-section relative">
            <i class="fa-regular fa-bookmark bookmark-badge" data-bookmark="section-maint"></i>
            <header class="mb-8 border-b border-slate-800 pb-4">
                <h2 class="text-3xl font-bold text-slate-100 mb-2">故障診斷與維護 (Troubleshooting)</h2>
                <div class="flex items-center gap-2 text-slate-400 text-sm"><span class="source-badge badge-standard">實戰經驗</span></div>
            </header>

            <div class="bg-slate-900 p-6 rounded-xl border border-slate-800 mb-6">
                <select id="diagnostic-select" onchange="showDiagnosis()" class="w-full p-3 bg-slate-800 border border-slate-700 rounded text-slate-200 mb-4">
                    <option value="">選擇症狀...</option>
                    <option value="ubuntu_dep">Ubuntu 24.04 安裝 CubeIDE 失敗</option>
                    <option value="sitl_udp">PX4 SITL 連接 Gazebo 逾時</option>
                    <option value="ros2_topic">ROS 2 找不到 /fmu 主題</option>
                    <option value="desync">馬達失步 (Motor Desync)</option>
                    <option value="mag">羅盤干擾 (Compass Error)</option>
                </select>
                <div id="diagnostic-result" class="hidden mt-4 p-4 bg-slate-950 border-l-4 border-emerald-500">
                    <h4 id="diag-title" class="font-bold text-emerald-400 mb-2"></h4>
                    <p id="diag-desc" class="text-sm text-slate-300 whitespace-pre-wrap"></p>
                </div>
            </div>
        </section>

        <!-- 15. Resources (NEW) -->
        <section id="section-resources" class="mb-16 hidden animate-section relative">
            <i class="fa-regular fa-bookmark bookmark-badge" data-bookmark="section-resources"></i>
            <header class="mb-8 border-b border-slate-800 pb-4">
                <h2 class="text-3xl font-bold text-slate-100 mb-2">資源與成本估算 (Resources & Cost)</h2>
            </header>
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
                    <h3 class="text-lg font-bold text-teal-400 mb-4">硬體成本估算 (2026 Q1 參考)</h3>
                    <table class="w-full text-sm text-slate-400">
                        <thead class="text-xs text-slate-500 bg-slate-950"><tr><th class="p-2 text-left">組件</th><th class="p-2 text-right">預估 (NTD)</th></tr></thead>
                        <tbody class="divide-y divide-slate-800">
                            <tr><td class="p-2">Pixhawk 6C 飛控</td><td class="p-2 text-right">3,500</td></tr>
                            <tr><td class="p-2">STM32H743 核心板</td><td class="p-2 text-right">1,200</td></tr>
                            <tr><td class="p-2">ESP32-S3 DevKit</td><td class="p-2 text-right">500</td></tr>
                            <tr><td class="p-2">Jetson Orin Nano (伴飛)</td><td class="p-2 text-right">12,000</td></tr>
                            <tr><td class="p-2">ST-Link V3 / J-Link</td><td class="p-2 text-right">600</td></tr>
                            <tr class="font-bold text-white bg-slate-800"><td class="p-2">總計 (不含機架動力)</td><td class="p-2 text-right">~17,800</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
                    <h3 class="text-lg font-bold text-sky-400 mb-4">社群與文檔資源</h3>
                    <ul class="space-y-3 text-sm text-slate-300">
                        <li><a href="https://docs.px4.io/main/zh/" target="_blank" class="hover:text-sky-400 transition"><i class="fa-solid fa-book mr-2"></i>PX4 官方文檔 (中文)</a></li>
                        <li><a href="https://ardupilot.org/copter/" target="_blank" class="hover:text-rose-400 transition"><i class="fa-solid fa-book mr-2"></i>ArduPilot Wiki</a></li>
                        <li><a href="https://docs.ros.org/en/humble/" target="_blank" class="hover:text-violet-400 transition"><i class="fa-brands fa-linux mr-2"></i>ROS 2 Humble 文檔</a></li>
                        <li><a href="https://micro.ros.org/" target="_blank" class="hover:text-emerald-400 transition"><i class="fa-solid fa-microchip mr-2"></i>micro-ROS 官網</a></li>
                    </ul>
                </div>
            </div>
        </section>

    </main>

    <script>
        // ==================== 全域變數 ====================
        let currentSection = 'section-roadmap';
        let vehicleChartInstance = null;
        let pidChartInstance = null;
        let bookmarks = JSON.parse(localStorage.getItem('uas-bookmarks') || '[]');
        let tourStep = 0;

        // ==================== 搜尋資料 (更新) ====================
        const searchData = [
            { title: '技術路線圖', section: 'section-roadmap', keywords: ['roadmap', 'imx', 'rt1176', 'pab', 'rtk'] },
            { title: 'X500 硬體拆解', section: 'section-teardown', keywords: ['x500', 'teardown', 'pixhawk', '6c'] },
            { title: 'MCU 架構詳解', section: 'section-mcu', keywords: ['mcu', 'stm32', 'h7', 'f103', 'io'] },
            { title: '自製硬體指南', section: 'section-design', keywords: ['design', 'diy', 'pinout'] },
            { title: 'Pixhawk 6X/6C', section: 'section-pixhawk', keywords: ['pixhawk', '6x', '6c'] },
            { title: 'BLDC 馬達實驗室', section: 'section-bldc', keywords: ['bldc', 'motor', 'esc', 'foc'] },
            { title: '系統概觀', section: 'section-intro', keywords: ['intro', 'overview', '飛行原理'] },
            { title: '硬體解剖', section: 'section-hardware', keywords: ['hardware', 'anatomy'] },
            { title: 'DShot 通訊時序', section: 'section-protocols', keywords: ['dshot', 'protocol'] },
            { title: 'PID 控制理論', section: 'section-pid', keywords: ['pid', 'control', 'tuning'] },
            { title: '開發環境', section: 'section-devenv', keywords: ['dev', 'environment', 'ide', 'cubeide', 'platformio', 'checklist'] },
            { title: '軟體棧 (PX4/ArduPilot)', section: 'section-software', keywords: ['software', 'stack', 'px4', 'ardupilot', 'uorb'] },
            { title: 'AIoT 與 ROS 2', section: 'section-aiot', keywords: ['aiot', 'ros2', 'esp32', 'micro-ros', 'humble'] },
            { title: '故障診斷', section: 'section-maint', keywords: ['debug', 'troubleshooting', 'ubuntu', 'sitl'] },
            { title: '資源與成本', section: 'section-resources', keywords: ['cost', 'bom', 'price', 'community'] }
        ];

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', function() {
            initNavigation();
            initCharts();
            initPortDetails();
            initMobileMenu();
            initScrollProgress();
            initBackToTop();
            initSearch();
            initBookmarks();
            initThemeToggle();
            updateBookmarkUI();
        });

        // ==================== 導航功能 ====================
        function initNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetSection = this.getAttribute('data-section');
                    showSection(targetSection);
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');
                });
            });
        }

        function showSection(sectionId) {
            document.querySelectorAll('section').forEach(section => section.classList.add('hidden'));
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.classList.add('animate-fade-in');
                currentSection = sectionId;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // ==================== Pixhawk 推薦 ====================
        function recommendBoard(useCase) {
            const rec = useCase === 'industrial' ? { board: 'Pixhawk 6X', color: 'emerald', reasons: ['三路冗餘', '硬體加密', 'Ethernet'] } : { board: 'Pixhawk 6C', color: 'sky', reasons: ['成本效益', '整合式設計', '雙路冗餘'] };
            const div = document.getElementById('recommendation-result');
            div.innerHTML = `<div class="flex items-start"><i class="fa-solid fa-lightbulb text-${rec.color}-400 text-2xl mr-3 mt-1"></i><div><strong class="text-${rec.color}-400 text-lg block mb-2">推薦: ${rec.board}</strong><ul class="space-y-2 text-sm text-slate-300">${rec.reasons.map(r => `<li>✓ ${r}</li>`).join('')}</ul></div></div>`;
            div.classList.remove('hidden', 'border-slate-600');
            div.classList.add('border-' + rec.color + '-500');
        }

        // ==================== 軟體棧切換 ====================
        function switchStack(id) {
            document.getElementById('content-px4').classList.add('hidden');
            document.getElementById('content-ardupilot').classList.add('hidden');
            document.getElementById(`content-${id}`).classList.remove('hidden');
            document.getElementById('tab-px4').className = id === 'px4' ? 'flex-1 py-4 font-bold text-sky-400 bg-slate-900 border-r border-slate-800 transition' : 'flex-1 py-4 font-bold text-slate-500 bg-slate-950 transition';
            document.getElementById('tab-ardupilot').className = id === 'ardupilot' ? 'flex-1 py-4 font-bold text-rose-400 bg-slate-900 transition' : 'flex-1 py-4 font-bold text-slate-500 bg-slate-950 transition';
        }

        // ==================== 設計指南切換 ====================
        function showDesignTab(tabId) {
            document.getElementById('content-modules').classList.add('hidden');
            document.getElementById('content-pinout').classList.add('hidden');
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            document.getElementById('tab-modules').className = tabId === 'modules' ? "px-6 py-4 text-sm font-bold text-pink-400 bg-slate-900 border-r border-slate-800 transition whitespace-nowrap" : "px-6 py-4 text-sm font-bold text-slate-500 bg-slate-950 transition whitespace-nowrap";
            document.getElementById('tab-pinout').className = tabId === 'pinout' ? "px-6 py-4 text-sm font-bold text-pink-400 bg-slate-900 border-l border-slate-800 transition whitespace-nowrap" : "px-6 py-4 text-sm font-bold text-slate-500 bg-slate-950 transition whitespace-nowrap";
        }

        // ==================== 故障診斷 (更新) ====================
        function showDiagnosis() {
            const v = document.getElementById('diagnostic-select').value;
            const r = document.getElementById('diagnostic-result');
            const t = document.getElementById('diag-title');
            const d = document.getElementById('diag-desc');
            if(!v) { r.classList.add('hidden'); return; }
            
            const db = {
                ubuntu_dep: { t:'Ubuntu 24.04 安裝 CubeIDE 失敗', d:'原因：缺少 libncurses5/libpython2.7。\n解法：需手動下載舊版 deb 包 (libncurses5_6.3 等) 並使用 dpkg 安裝，然後再安裝 CubeIDE。' },
                sitl_udp: { t:'SITL 連接 Gazebo 逾時', d:'解法：1. 檢查防火牆 (ufw allow 14550/udp)。\n2. 設定 export PX4_SIM_HOST_ADDR=127.0.0.1。\n3. 使用 make px4_sitl_default gazebo __verbose:=1 查看詳細錯誤。' },
                ros2_topic: { t:'ROS 2 找不到 /fmu 主題', d:'解法：1. 確認 micro_xrce_dds_agent 已啟動 (udp4 -p 8888)。\n2. 確認 PX4 SITL 運行中。\n3. 重新 source /opt/ros/humble/setup.bash。' },
                desync: { t:'馬達失步 (Desync)', d:'建議操作：1. 在 BLHeli 中增加 Rampup Power。 2. 檢查馬達接線是否鬆脫。' },
                mag: { t:'羅盤干擾 (TBE)', d:'建議操作：1. 重新校準磁羅盤。 2. 將 GPS 支架移離 PDB 或電源線。' }
            };
            
            const data = db[v];
            if(data) { t.innerText = data.t; d.innerText = data.d; r.classList.remove('hidden'); }
        }

        // ==================== 其他初始化 ====================
        function initCharts() {
            const pidCtx = document.getElementById('pidChart');
            if (pidCtx) {
                const timeData = Array.from({length: 50}, (_, i) => i * 0.1);
                pidChartInstance = new Chart(pidCtx, {
                    type: 'line',
                    data: {
                        labels: timeData,
                        datasets: [
                            { label: 'P Only', data: timeData.map(t => 1 - Math.exp(-t) + 0.2 * Math.sin(3*t)), borderColor: 'rgb(16, 185, 129)', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4 },
                            { label: 'PD', data: timeData.map(t => 1 - Math.exp(-1.5*t) + 0.05 * Math.sin(4*t)), borderColor: 'rgb(56, 189, 248)', backgroundColor: 'rgba(56, 189, 248, 0.1)', tension: 0.4 },
                            { label: 'PID', data: timeData.map(t => 1 - Math.exp(-2*t)), borderColor: 'rgb(251, 191, 36)', backgroundColor: 'rgba(251, 191, 36, 0.1)', tension: 0.4 },
                            { label: 'Target', data: timeData.map(() => 1), borderColor: 'rgb(148, 163, 184)', borderDash: [5, 5], pointRadius: 0 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { ticks: { color: '#64748b' }, grid: { color: '#334155' } } }, plugins: { legend: { labels: { color: '#cbd5e1' } } } }
                });
            }
            const vehicleCtx = document.getElementById('vehicleChart');
            if (vehicleCtx) {
                vehicleChartInstance = new Chart(vehicleCtx, {
                    type: 'radar',
                    data: {
                        labels: ['速度', '續航', '載重', '穩定性', '成本'],
                        datasets: [
                            { label: '多旋翼', data: [8, 6, 7, 9, 7], borderColor: 'rgb(56, 189, 248)', backgroundColor: 'rgba(56, 189, 248, 0.2)' },
                            { label: '固定翼', data: [9, 9, 6, 7, 6], borderColor: 'rgb(16, 185, 129)', backgroundColor: 'rgba(16, 185, 129, 0.2)' }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { r: { ticks: { display: false }, grid: { color: '#334155' }, pointLabels: { color: '#cbd5e1' } } }, plugins: { legend: { labels: { color: '#cbd5e1' } } } }
                });
            }
        }

        function initPortDetails() {
            const portConnectors = document.querySelectorAll('.port-connector');
            const portData = {
                power: { icon: '<i class="fa-solid fa-battery-full text-rose-500"></i>', title: 'POWER 1 & 2', content: '<table class="w-full pin-table"><tr><th>Pin</th><th>Function</th><th>Voltage</th></tr><tr><td>1,2</td><td>VCC</td><td class="v-5">5V</td></tr><tr><td>3</td><td>I_SENS</td><td class="v-33">3.3V</td></tr><tr><td>4</td><td>V_SENS</td><td class="v-33">3.3V</td></tr><tr><td>5,6</td><td>GND</td><td class="v-gnd">GND</td></tr></table>' },
                gps: { icon: '<i class="fa-solid fa-satellite text-emerald-500"></i>', title: 'GPS 1', content: '<table class="w-full pin-table"><tr><th>Pin</th><th>Function</th></tr><tr><td>1</td><td>VCC</td></tr><tr><td>2,3</td><td>TX/RX</td></tr><tr><td>4,5</td><td>I2C</td></tr><tr><td>6</td><td>Safety</td></tr></table>' },
                telem: { icon: '<i class="fa-solid fa-wifi text-sky-500"></i>', title: 'TELEM 1', content: '<table class="w-full pin-table"><tr><th>Pin</th><th>Function</th></tr><tr><td>1</td><td>VCC</td></tr><tr><td>2,3</td><td>TX/RX</td></tr><tr><td>4,5</td><td>CTS/RTS</td></tr></table>' },
                fmu_pwm: { icon: '<i class="fa-solid fa-fan text-amber-500"></i>', title: 'FMU PWM', content: '由主處理器 (FMU) 直接輸出。支援 DShot/OneShot。' },
                io_pwm: { icon: '<i class="fa-solid fa-gears text-slate-400"></i>', title: 'IO PWM', content: '由 F103 協處理器輸出，具備 Failsafe 保護。' },
                can: { icon: '<i class="fa-solid fa-network-wired text-indigo-500"></i>', title: 'CAN 1/2', content: '<table class="w-full pin-table"><tr><th>Pin</th><th>Function</th></tr><tr><td>1</td><td>VCC</td></tr><tr><td>2</td><td>CAN_H</td></tr><tr><td>3</td><td>CAN_L</td></tr><tr><td>4</td><td>GND</td></tr></table>' }
            };
            portConnectors.forEach(c => {
                c.addEventListener('click', function() {
                    const d = portData[this.getAttribute('data-port')];
                    if(d) {
                        document.getElementById('port-icon').innerHTML = d.icon;
                        document.getElementById('port-title').textContent = d.title;
                        document.getElementById('port-content').innerHTML = d.content;
                        portConnectors.forEach(el => el.classList.remove('ring-2', 'ring-sky-500'));
                        this.classList.add('ring-2', 'ring-sky-500');
                    }
                });
            });
        }

        function showBldcDetail(k) {
            const data = {
                mcu: { t:'STM32 G4', d:'CORDIC/FMAC 數學加速器，專為 FOC 設計。', s:['170MHz Cortex-M4', '3x ADC (同步採樣)', 'Advanced Timer'] },
                driver: { t:'Gate Driver', d:'驅動 MOSFET 閘極，控制死區時間 (Deadtime)。', s:['Bootstrap 電路', '保護機制 (OCP, OTP)', '驅動電流 > 1A'] },
                mosfet: { t:'MOSFETs', d:'三相逆變橋，低導通電阻。', s:['Vds > 電池電壓 x 1.5', 'Rds(on) < 3mΩ', 'DFN 5x6 封裝'] }
            };
            const d = data[k];
            document.getElementById('bldc-title').innerText = d.t;
            document.getElementById('bldc-desc').innerText = d.d;
            document.getElementById('bldc-specs').innerHTML = d.s.map(i => `<li>> ${i}</li>`).join('');
            document.getElementById('bldc-detail-box').classList.remove('hidden');
        }

        function initMobileMenu() {
            document.getElementById('mobile-menu-btn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('hidden');
            });
        }
        function initScrollProgress() {
            window.addEventListener('scroll', () => {
                const scrolled = window.scrollY;
                const max = document.documentElement.scrollHeight - window.innerHeight;
                document.getElementById('reading-progress').style.width = (scrolled / max) * 100 + '%';
            });
        }
        function initBackToTop() {
            const btn = document.getElementById('back-to-top');
            window.addEventListener('scroll', () => {
                if(window.scrollY > 300) btn.classList.add('visible'); else btn.classList.remove('visible');
            });
            btn.addEventListener('click', () => window.scrollTo({top: 0, behavior: 'smooth'}));
        }
        function initSearch() {
            const input = document.getElementById('search-input');
            const results = document.getElementById('search-results');
            input.addEventListener('input', (e) => {
                const q = e.target.value.toLowerCase();
                if(q.length < 2) { results.classList.add('hidden'); return; }
                const res = searchData.filter(d => d.title.toLowerCase().includes(q) || d.keywords.some(k => k.includes(q)));
                results.innerHTML = res.length ? res.map(r => `<div class="search-result-item" onclick="showSection('${r.section}')"><div class="font-bold text-slate-200 text-sm">${r.title}</div></div>`).join('') : '<div class="p-2 text-slate-500 text-sm">無結果</div>';
                results.classList.remove('hidden');
            });
        }
        function initBookmarks() {
            document.querySelectorAll('.bookmark-badge').forEach(b => {
                const sid = b.getAttribute('data-bookmark');
                if(bookmarks.includes(sid)) b.classList.add('bookmarked', 'fa-solid');
                b.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if(bookmarks.includes(sid)) { bookmarks = bookmarks.filter(i => i !== sid); b.classList.remove('bookmarked', 'fa-solid'); b.classList.add('fa-regular'); }
                    else { bookmarks.push(sid); b.classList.add('bookmarked', 'fa-solid'); b.classList.remove('fa-regular'); }
                    localStorage.setItem('uas-bookmarks', JSON.stringify(bookmarks));
                    updateBookmarkUI();
                });
            });
        }
        function updateBookmarkUI() {
            const list = document.getElementById('bookmark-list');
            document.getElementById('bookmark-count').innerText = bookmarks.length;
            if(!bookmarks.length) { list.innerHTML = '<div class="text-slate-600 italic">無書籤</div>'; return; }
            list.innerHTML = bookmarks.map(bid => {
                const d = searchData.find(s => s.section === bid);
                return `<div class="flex justify-between p-2 bg-slate-800 rounded cursor-pointer hover:bg-slate-700" onclick="showSection('${bid}')"><span class="text-slate-300">${d ? d.title : bid}</span></div>`;
            }).join('');
        }
        function initThemeToggle() {
            const t = document.getElementById('theme-toggle');
            if(localStorage.getItem('uas-theme') === 'light') { document.documentElement.classList.remove('dark'); t.classList.remove('active'); }
            t.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                t.classList.toggle('active');
                localStorage.setItem('uas-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            });
        }
        function startTour() {
            const overlay = document.getElementById('tour-overlay');
            overlay.innerHTML = `<div class="tour-tooltip" style="top:50%;left:50%;transform:translate(-50%,-50%)"><h3 class="font-bold text-white mb-2">歡迎使用 UAS R&D Hub</h3><p class="text-slate-300 text-sm mb-4">左側選單包含所有技術章節。請依序瀏覽。</p><button class="tour-btn tour-btn-primary" onclick="document.getElementById('tour-overlay').classList.remove('active')">開始探索</button></div>`;
            overlay.classList.add('active');
        }
        
        // MathJax
        window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] } };
        
        // Initial anatomy grid
        const anatomyData = [
            { id: 'brain', icon: '🧠', title: 'FC (大腦)', desc: 'H753', specs: ['三路 IMU'] },
            { id: 'muscle', icon: '💪', title: 'ESC (肌肉)', desc: 'FOC', specs: ['DShot600'] },
            { id: 'senses', icon: '👁️', title: 'Sensor (感官)', desc: '陣列', specs: ['ICM/BMI'] },
            { id: 'heart', icon: '🔋', title: 'Power (心臟)', desc: 'PM02D', specs: ['I2C 數位'] }
        ];
        const ag = document.getElementById('anatomy-grid');
        if(ag) anatomyData.forEach(d => {
            const div = document.createElement('div');
            div.className = 'interactive-card bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-lg text-center group';
            div.onclick = () => {
                document.getElementById('detail-title').innerText = d.title;
                document.getElementById('detail-desc').innerText = d.desc;
                document.getElementById('detail-specs').innerHTML = d.specs.map(s => `<li>> ${s}</li>`).join('');
                document.getElementById('anatomy-detail').classList.remove('hidden');
            };
            div.innerHTML = `<div class="text-3xl mb-2 grayscale group-hover:grayscale-0 transition">${d.icon}</div><h3 class="font-bold text-slate-200 text-sm">${d.title}</h3>`;
            ag.appendChild(div);
        });

        // Initial DShot bits
        const db = document.getElementById('dshot-bits');
        if(db) for(let i=0; i<16; i++) {
            const b = document.createElement('div');
            let color = i < 11 ? 'bg-emerald-500' : (i < 12 ? 'bg-amber-500' : 'bg-rose-500');
            b.className = `bit-box w-5 h-8 md:w-6 md:h-10 ${color} rounded opacity-60 hover:opacity-100 border border-white/10 m-0.5 cursor-help`;
            db.appendChild(b);
        }
    </script>
</body>
</html>
